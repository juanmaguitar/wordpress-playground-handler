{"version":3,"file":"index.cjs","sources":["../../../../packages/php-wasm/universal/src/lib/rethrow-file-system-error.ts","../../../../packages/php-wasm/universal/src/lib/fs-helpers.ts","../../../../packages/php-wasm/universal/src/lib/php-worker.ts","../../../../packages/php-wasm/universal/src/lib/php-response.ts","../../../../packages/php-wasm/universal/src/lib/load-php-runtime.ts","../../../../packages/php-wasm/universal/src/lib/error-event-polyfill.ts","../../../../packages/php-wasm/universal/src/lib/is-exit-code.ts","../../../../packages/php-wasm/universal/src/lib/wasm-error-reporting.ts","../../../../packages/php-wasm/universal/src/lib/php.ts","../../../../packages/php-wasm/universal/src/lib/ini.ts","../../../../packages/php-wasm/universal/src/lib/http-cookie-store.ts","../../../../packages/php-wasm/universal/src/lib/stream-read-file-from-php.ts","../../../../packages/php-wasm/universal/src/lib/iterate-files.ts","../../../../packages/php-wasm/universal/src/lib/write-files-stream-to-php.ts","../../../../packages/php-wasm/universal/src/lib/php-process-manager.ts","../../../../packages/php-wasm/universal/src/lib/supported-php-versions.ts","../../../../packages/php-wasm/universal/src/lib/urls.ts","../../../../packages/php-wasm/universal/src/lib/encode-as-multipart.ts","../../../../packages/php-wasm/universal/src/lib/php-request-handler.ts","../../../../packages/php-wasm/universal/src/lib/rotate-php-runtime.ts","../../../../packages/php-wasm/universal/src/lib/write-files.ts","../../../../packages/php-wasm/universal/src/lib/proxy-file-system.ts","../../../../node_modules/comlink/dist/esm/node-adapter.mjs","../../../../packages/php-wasm/universal/src/lib/api.ts"],"sourcesContent":["/**\n * Emscripten's filesystem-related Exception.\n *\n * @see https://emscripten.org/docs/api_reference/Filesystem-API.html\n * @see https://github.com/emscripten-core/emscripten/blob/main/system/lib/libc/musl/arch/emscripten/bits/errno.h\n * @see https://github.com/emscripten-core/emscripten/blob/38eedc630f17094b3202fd48ac0c2c585dbea31e/system/include/wasi/api.h#L336\n */\n\nexport interface ErrnoError extends Error {\n\tnode?: any;\n\terrno: number;\n\tmessage: string;\n}\n/**\n * @see https://github.com/emscripten-core/emscripten/blob/38eedc630f17094b3202fd48ac0c2c585dbea31e/system/include/wasi/api.h#L336\n */\nexport const FileErrorCodes = {\n\t0: 'No error occurred. System call completed successfully.',\n\t1: 'Argument list too long.',\n\t2: 'Permission denied.',\n\t3: 'Address in use.',\n\t4: 'Address not available.',\n\t5: 'Address family not supported.',\n\t6: 'Resource unavailable, or operation would block.',\n\t7: 'Connection already in progress.',\n\t8: 'Bad file descriptor.',\n\t9: 'Bad message.',\n\t10: 'Device or resource busy.',\n\t11: 'Operation canceled.',\n\t12: 'No child processes.',\n\t13: 'Connection aborted.',\n\t14: 'Connection refused.',\n\t15: 'Connection reset.',\n\t16: 'Resource deadlock would occur.',\n\t17: 'Destination address required.',\n\t18: 'Mathematics argument out of domain of function.',\n\t19: 'Reserved.',\n\t20: 'File exists.',\n\t21: 'Bad address.',\n\t22: 'File too large.',\n\t23: 'Host is unreachable.',\n\t24: 'Identifier removed.',\n\t25: 'Illegal byte sequence.',\n\t26: 'Operation in progress.',\n\t27: 'Interrupted function.',\n\t28: 'Invalid argument.',\n\t29: 'I/O error.',\n\t30: 'Socket is connected.',\n\t31: 'There is a directory under that path.',\n\t32: 'Too many levels of symbolic links.',\n\t33: 'File descriptor value too large.',\n\t34: 'Too many links.',\n\t35: 'Message too large.',\n\t36: 'Reserved.',\n\t37: 'Filename too long.',\n\t38: 'Network is down.',\n\t39: 'Connection aborted by network.',\n\t40: 'Network unreachable.',\n\t41: 'Too many files open in system.',\n\t42: 'No buffer space available.',\n\t43: 'No such device.',\n\t44: 'There is no such file or directory OR the parent directory does not exist.',\n\t45: 'Executable file format error.',\n\t46: 'No locks available.',\n\t47: 'Reserved.',\n\t48: 'Not enough space.',\n\t49: 'No message of the desired type.',\n\t50: 'Protocol not available.',\n\t51: 'No space left on device.',\n\t52: 'Function not supported.',\n\t53: 'The socket is not connected.',\n\t54: 'Not a directory or a symbolic link to a directory.',\n\t55: 'Directory not empty.',\n\t56: 'State not recoverable.',\n\t57: 'Not a socket.',\n\t58: 'Not supported, or operation not supported on socket.',\n\t59: 'Inappropriate I/O control operation.',\n\t60: 'No such device or address.',\n\t61: 'Value too large to be stored in data type.',\n\t62: 'Previous owner died.',\n\t63: 'Operation not permitted.',\n\t64: 'Broken pipe.',\n\t65: 'Protocol error.',\n\t66: 'Protocol not supported.',\n\t67: 'Protocol wrong type for socket.',\n\t68: 'Result too large.',\n\t69: 'Read-only file system.',\n\t70: 'Invalid seek.',\n\t71: 'No such process.',\n\t72: 'Reserved.',\n\t73: 'Connection timed out.',\n\t74: 'Text file busy.',\n\t75: 'Cross-device link.',\n\t76: 'Extension: Capabilities insufficient.',\n} as any;\n\nexport function getEmscriptenFsError(e: any) {\n\tconst errno = typeof e === 'object' ? ((e as any)?.errno as any) : null;\n\tif (errno in FileErrorCodes) {\n\t\treturn FileErrorCodes[errno];\n\t}\n}\n\nexport function rethrowFileSystemError(messagePrefix = '') {\n\treturn function catchFileSystemError(value: (...args: any[]) => any) {\n\t\treturn function (...args: any[]) {\n\t\t\ttry {\n\t\t\t\t// @ts-expect-error Parameter 'this' implicitly has an 'any' type.ts(7006)\n\t\t\t\treturn value.apply(this, args);\n\t\t\t} catch (e) {\n\t\t\t\tconst errno =\n\t\t\t\t\ttypeof e === 'object' ? ((e as any)?.errno as any) : null;\n\t\t\t\tif (errno in FileErrorCodes) {\n\t\t\t\t\tconst errmsg = FileErrorCodes[errno];\n\t\t\t\t\tconst path = typeof args[1] === 'string' ? args[1] : null;\n\t\t\t\t\tconst formattedPrefix =\n\t\t\t\t\t\tpath !== null\n\t\t\t\t\t\t\t? messagePrefix.replaceAll('{path}', path)\n\t\t\t\t\t\t\t: messagePrefix;\n\t\t\t\t\tthrow new Error(`${formattedPrefix}: ${errmsg}`, {\n\t\t\t\t\t\tcause: e,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t};\n\t};\n}\n","import type { Emscripten } from './emscripten-types';\nimport {\n\tgetEmscriptenFsError,\n\trethrowFileSystemError,\n} from './rethrow-file-system-error';\nimport { logger } from '@php-wasm/logger';\nimport { dirname, joinPaths } from '@php-wasm/util';\n\nexport interface RmDirOptions {\n\t/**\n\t * If true, recursively removes the directory and all its contents.\n\t * Default: true.\n\t */\n\trecursive?: boolean;\n}\n\nexport interface ListFilesOptions {\n\t/**\n\t * If true, prepend given folder path to all file names.\n\t * Default: false.\n\t */\n\tprependPath: boolean;\n}\n\nexport class FSHelpers {\n\t/**\n\t * Reads a file from the PHP filesystem and returns it as a string.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param FS\n\t * @param  path - The file path to read.\n\t * @returns The file contents.\n\t */\n\tstatic readFileAsText(FS: Emscripten.RootFS, path: string) {\n\t\treturn new TextDecoder().decode(FSHelpers.readFileAsBuffer(FS, path));\n\t}\n\n\t/**\n\t * Reads a file from the PHP filesystem and returns it as an array buffer.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param FS\n\t * @param  path - The file path to read.\n\t * @returns The file contents.\n\t */\n\tstatic readFileAsBuffer(FS: Emscripten.RootFS, path: string): Uint8Array {\n\t\treturn FS.readFile(path);\n\t}\n\n\t/**\n\t * Overwrites data in a file in the PHP filesystem.\n\t * Creates a new file if one doesn't exist yet.\n\t *\n\t * @param FS\n\t * @param  path - The file path to write to.\n\t * @param  data - The data to write to the file.\n\t */\n\tstatic writeFile(\n\t\tFS: Emscripten.RootFS,\n\t\tpath: string,\n\t\tdata: string | Uint8Array\n\t) {\n\t\tFS.writeFile(path, data);\n\t}\n\n\t/**\n\t * Removes a file from the PHP filesystem.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param FS\n\t * @param  path - The file path to remove.\n\t */\n\tstatic unlink(FS: Emscripten.RootFS, path: string) {\n\t\tFS.unlink(path);\n\t}\n\n\t/**\n\t * Moves a file or directory in the PHP filesystem to a\n\t * new location.\n\t *\n\t * @param FS\n\t * @param fromPath The path to rename.\n\t * @param toPath The new path.\n\t */\n\tstatic mv(FS: Emscripten.RootFS, fromPath: string, toPath: string) {\n\t\ttry {\n\t\t\t// FS.rename moves the inode within the same filesystem.\n\t\t\t// If fromPath and toPath are on different filesystems,\n\t\t\t// the operation will fail. In that case, we need to do\n\t\t\t// a recursive copy of all the files and remove the original.\n\t\t\t// Note this is also what happens in the linux `mv` command.\n\t\t\tconst fromMount = FS.lookupPath(fromPath).node.mount;\n\t\t\tconst toMount = FSHelpers.fileExists(FS, toPath)\n\t\t\t\t? FS.lookupPath(toPath).node.mount\n\t\t\t\t: FS.lookupPath(dirname(toPath)).node.mount;\n\t\t\tconst movingBetweenFilesystems =\n\t\t\t\tfromMount.mountpoint !== toMount.mountpoint;\n\n\t\t\tif (movingBetweenFilesystems) {\n\t\t\t\tFSHelpers.copyRecursive(FS, fromPath, toPath);\n\t\t\t\tif (FSHelpers.isDir(FS, fromPath)) {\n\t\t\t\t\tFSHelpers.rmdir(FS, fromPath, { recursive: true });\n\t\t\t\t} else {\n\t\t\t\t\tFS.unlink(fromPath);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tFS.rename(fromPath, toPath);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconst errmsg = getEmscriptenFsError(e);\n\t\t\tif (!errmsg) {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t\tthrow new Error(\n\t\t\t\t`Could not move ${fromPath} to ${toPath}: ${errmsg}`,\n\t\t\t\t{\n\t\t\t\t\tcause: e,\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Removes a directory from the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param path The directory path to remove.\n\t * @param options Options for the removal.\n\t */\n\tstatic rmdir(\n\t\tFS: Emscripten.RootFS,\n\t\tpath: string,\n\t\toptions: RmDirOptions = { recursive: true }\n\t) {\n\t\tif (options?.recursive) {\n\t\t\tFSHelpers.listFiles(FS, path).forEach((file) => {\n\t\t\t\tconst filePath = `${path}/${file}`;\n\t\t\t\tif (FSHelpers.isDir(FS, filePath)) {\n\t\t\t\t\tFSHelpers.rmdir(FS, filePath, options);\n\t\t\t\t} else {\n\t\t\t\t\tFSHelpers.unlink(FS, filePath);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tif (FS.getPath(FS.lookupPath(path).node) === FS.cwd()) {\n\t\t\tFS.chdir(joinPaths(FS.cwd(), '..'));\n\t\t}\n\t\tFS.rmdir(path);\n\t}\n\n\t/**\n\t * Lists the files and directories in the given directory.\n\t *\n\t * @param FS\n\t * @param  path - The directory path to list.\n\t * @param  options - Options for the listing.\n\t * @returns The list of files and directories in the given directory.\n\t */\n\tstatic listFiles(\n\t\tFS: Emscripten.RootFS,\n\t\tpath: string,\n\t\toptions: ListFilesOptions = { prependPath: false }\n\t): string[] {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn [];\n\t\t}\n\t\ttry {\n\t\t\tconst files = FS.readdir(path).filter(\n\t\t\t\t(name: string) => name !== '.' && name !== '..'\n\t\t\t);\n\t\t\tif (options.prependPath) {\n\t\t\t\tconst prepend = path.replace(/\\/$/, '');\n\t\t\t\treturn files.map((name: string) => `${prepend}/${name}`);\n\t\t\t}\n\t\t\treturn files;\n\t\t} catch (e) {\n\t\t\tlogger.error(e, { path });\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Checks if a directory exists in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param  path – The path to check.\n\t * @returns True if the path is a directory, false otherwise.\n\t */\n\tstatic isDir(FS: Emscripten.RootFS, path: string): boolean {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn FS.isDir(FS.lookupPath(path, { follow: true }).node.mode);\n\t}\n\n\t/**\n\t * Checks if a file exists in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param  path – The path to check.\n\t * @returns True if the path is a file, false otherwise.\n\t */\n\tstatic isFile(FS: Emscripten.RootFS, path: string): boolean {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn FS.isFile(FS.lookupPath(path, { follow: true }).node.mode);\n\t}\n\n\t/**\n\t * Creates a symlink in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param target\n\t * @param link\n\t */\n\tstatic symlink(FS: Emscripten.RootFS, target: string, link: string): any {\n\t\treturn FS.symlink(target, link);\n\t}\n\n\t/**\n\t * Checks if a path is a symlink in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param path\n\t * @returns True if the path is a symlink, false otherwise.\n\t */\n\tstatic isSymlink(FS: Emscripten.RootFS, path: string): boolean {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn FS.isLink(FS.lookupPath(path).node.mode);\n\t}\n\n\t/**\n\t * Reads the target of a symlink in the PHP filesystem.\n\t * @param FS\n\t * @param path\n\t * @returns The target of the symlink.\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the path is not a symlink.\n\t */\n\tstatic readlink(FS: Emscripten.RootFS, path: string): string {\n\t\treturn FS.readlink(path);\n\t}\n\n\t/**\n\t * Gets the real path of a file in the PHP filesystem.\n\t * @param FS\n\t * @param path\n\t *\n\t * @returns The real path of the file.\n\t */\n\tstatic realpath(FS: Emscripten.RootFS, path: string): string {\n\t\treturn FS.lookupPath(path, { follow: true }).path;\n\t}\n\n\t/**\n\t * Checks if a file (or a directory) exists in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param  path - The file path to check.\n\t * @returns True if the file exists, false otherwise.\n\t */\n\tstatic fileExists(FS: Emscripten.RootFS, path: string): boolean {\n\t\ttry {\n\t\t\tFS.lookupPath(path);\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Recursively creates a directory with the given path in the PHP filesystem.\n\t * For example, if the path is `/root/php/data`, and `/root` already exists,\n\t * it will create the directories `/root/php` and `/root/php/data`.\n\t *\n\t * @param FS\n\t * @param  path - The directory path to create.\n\t */\n\tstatic mkdir(FS: Emscripten.RootFS, path: string) {\n\t\tFS.mkdirTree(path);\n\t}\n\n\tstatic copyRecursive(\n\t\tFS: Emscripten.FileSystemInstance,\n\t\tfromPath: string,\n\t\ttoPath: string\n\t) {\n\t\tconst fromNode = FS.lookupPath(fromPath).node;\n\t\tif (FS.isDir(fromNode.mode)) {\n\t\t\tFS.mkdirTree(toPath);\n\t\t\tconst filenames = FS.readdir(fromPath).filter(\n\t\t\t\t(name: string) => name !== '.' && name !== '..'\n\t\t\t);\n\t\t\tfor (const filename of filenames) {\n\t\t\t\tFSHelpers.copyRecursive(\n\t\t\t\t\tFS,\n\t\t\t\t\tjoinPaths(fromPath, filename),\n\t\t\t\t\tjoinPaths(toPath, filename)\n\t\t\t\t);\n\t\t\t}\n\t\t} else {\n\t\t\tFS.writeFile(toPath, FS.readFile(fromPath));\n\t\t}\n\t}\n}\n\n// Apply decorators manually until the decorator syntax is supported\n// by Node.js. We do this so we can take advantage of Node.js type stripping\n// in the meantime.\n// TODO: Inline these decorators once Node.js supports it.\nFSHelpers.readFileAsText = rethrowFileSystemError('Could not read \"{path}\"')(\n\tFSHelpers.readFileAsText\n);\nFSHelpers.readFileAsBuffer = rethrowFileSystemError('Could not read \"{path}\"')(\n\tFSHelpers.readFileAsBuffer\n);\nFSHelpers.writeFile = rethrowFileSystemError('Could not write to \"{path}\"')(\n\tFSHelpers.writeFile\n);\nFSHelpers.unlink = rethrowFileSystemError('Could not unlink \"{path}\"')(\n\tFSHelpers.unlink\n);\nFSHelpers.rmdir = rethrowFileSystemError('Could not remove directory \"{path}\"')(\n\tFSHelpers.rmdir\n);\nFSHelpers.listFiles = rethrowFileSystemError(\n\t'Could not list files in \"{path}\"'\n)(FSHelpers.listFiles);\nFSHelpers.isDir = rethrowFileSystemError('Could not stat \"{path}\"')(\n\tFSHelpers.isDir\n);\nFSHelpers.isFile = rethrowFileSystemError('Could not stat \"{path}\"')(\n\tFSHelpers.isFile\n);\nFSHelpers.realpath = rethrowFileSystemError('Could not stat \"{path}\"')(\n\tFSHelpers.realpath\n);\nFSHelpers.fileExists = rethrowFileSystemError('Could not stat \"{path}\"')(\n\tFSHelpers.fileExists\n);\nFSHelpers.mkdir = rethrowFileSystemError('Could not create directory \"{path}\"')(\n\tFSHelpers.mkdir\n);\nFSHelpers.copyRecursive = rethrowFileSystemError(\n\t'Could not copy files from \"{path}\"'\n)(FSHelpers.copyRecursive);\n","import type { EmscriptenDownloadMonitor } from '@php-wasm/progress';\nimport type { PHP } from './php';\nimport type { PHPRequestHandler } from './php-request-handler';\nimport type { PHPResponse } from './php-response';\nimport type {\n\tPHPRequest,\n\tPHPRunOptions,\n\tMessageListener,\n\tPHPEvent,\n\tPHPEventListener,\n} from './universal-php';\nimport type { RmDirOptions, ListFilesOptions } from './fs-helpers';\n\nconst _private = new WeakMap<\n\tPHPWorker,\n\t{\n\t\trequestHandler?: PHPRequestHandler;\n\t\tphp?: PHP;\n\t\tmonitor?: EmscriptenDownloadMonitor;\n\t}\n>();\n\nexport type LimitedPHPApi = Pick<\n\tPHP,\n\t| 'request'\n\t| 'defineConstant'\n\t| 'addEventListener'\n\t| 'removeEventListener'\n\t| 'mkdir'\n\t| 'mkdirTree'\n\t| 'readFileAsText'\n\t| 'readFileAsBuffer'\n\t| 'writeFile'\n\t| 'unlink'\n\t| 'mv'\n\t| 'rmdir'\n\t| 'listFiles'\n\t| 'isDir'\n\t| 'fileExists'\n\t| 'chdir'\n\t| 'run'\n\t| 'onMessage'\n> & {\n\tdocumentRoot: PHP['documentRoot'];\n\tabsoluteUrl: PHP['absoluteUrl'];\n};\n\n/**\n * A PHP client that can be used to run PHP code in the browser.\n */\nexport class PHPWorker implements LimitedPHPApi, AsyncDisposable {\n\t/** @inheritDoc @php-wasm/universal!RequestHandler.absoluteUrl  */\n\tabsoluteUrl = '';\n\t/** @inheritDoc @php-wasm/universal!RequestHandler.documentRoot  */\n\tdocumentRoot = '';\n\n\t/** @inheritDoc */\n\tconstructor(\n\t\trequestHandler?: PHPRequestHandler,\n\t\tmonitor?: EmscriptenDownloadMonitor\n\t) {\n\t\t/**\n\t\t * Workaround for TypeScript limitation.\n\t\t * Declaring a private field using the EcmaScript syntax like this:\n\t\t *\n\t\t *     #php: PHP\n\t\t *\n\t\t * Makes that field a part of the public API of the class. This means\n\t\t * you can no longer assign seemingly compatible objects:\n\t\t *\n\t\t * ```ts\n\t\t *     class PrivateEcma {\n\t\t *       #privateProp: string = '';\n\t\t *       callback() { }\n\t\t *     }\n\t\t *     interface CompatibleInterface {\n\t\t *       callback(): void;\n\t\t *     }\n\t\t *     const compatObj: CompatibleInterface = {} as any;\n\t\t *     const tsObj: PrivateEcma = compatObj;\n\t\t *     // Property '#privateProp' is missing in type 'CompatibleInterface' but\n\t\t *     // required in type 'PrivateEcma'\n\t\t * ```\n\t\t */\n\t\t_private.set(this, {\n\t\t\tmonitor,\n\t\t});\n\t\tif (requestHandler) {\n\t\t\tthis.__internal_setRequestHandler(requestHandler);\n\t\t}\n\t}\n\n\tpublic __internal_setRequestHandler(requestHandler: PHPRequestHandler) {\n\t\tthis.absoluteUrl = requestHandler.absoluteUrl;\n\t\tthis.documentRoot = requestHandler.documentRoot;\n\t\t_private.set(this, {\n\t\t\t..._private.get(this),\n\t\t\trequestHandler,\n\t\t});\n\t}\n\n\t/**\n\t * @internal\n\t * @deprecated\n\t * Do not use this method directly in the code consuming\n\t * the web API. It will change or even be removed without\n\t * a warning.\n\t */\n\tprotected __internal_getPHP() {\n\t\treturn _private.get(this)!.php;\n\t}\n\n\tasync setPrimaryPHP(php: PHP) {\n\t\t_private.set(this, {\n\t\t\t..._private.get(this)!,\n\t\t\tphp,\n\t\t});\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!PHPRequestHandler.pathToInternalUrl  */\n\tpathToInternalUrl(path: string): string {\n\t\treturn _private.get(this)!.requestHandler!.pathToInternalUrl(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!PHPRequestHandler.internalUrlToPath  */\n\tinternalUrlToPath(internalUrl: string): string {\n\t\treturn _private\n\t\t\t.get(this)!\n\t\t\t.requestHandler!.internalUrlToPath(internalUrl);\n\t}\n\n\t/**\n\t * The onDownloadProgress event listener.\n\t */\n\tasync onDownloadProgress(\n\t\tcallback: (progress: CustomEvent<ProgressEvent>) => void\n\t): Promise<void> {\n\t\treturn _private\n\t\t\t.get(this)!\n\t\t\t.monitor?.addEventListener('progress', callback as any);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!PHP.mv  */\n\tasync mv(fromPath: string, toPath: string) {\n\t\treturn _private.get(this)!.php!.mv(fromPath, toPath);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!PHP.rmdir  */\n\tasync rmdir(path: string, options?: RmDirOptions) {\n\t\treturn _private.get(this)!.php!.rmdir(path, options);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!PHPRequestHandler.request */\n\tasync request(request: PHPRequest): Promise<PHPResponse> {\n\t\tconst requestHandler = _private.get(this)!.requestHandler!;\n\t\treturn await requestHandler.request(request);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.run */\n\tasync run(request: PHPRunOptions): Promise<PHPResponse> {\n\t\tconst { php, reap } = await _private\n\t\t\t.get(this)!\n\t\t\t.requestHandler!.processManager.acquirePHPInstance();\n\t\ttry {\n\t\t\treturn await php.run(request);\n\t\t} finally {\n\t\t\treap();\n\t\t}\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.chdir */\n\tchdir(path: string): void {\n\t\treturn _private.get(this)!.php!.chdir(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.setSapiName */\n\tsetSapiName(newName: string): void {\n\t\t_private.get(this)!.php!.setSapiName(newName);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.mkdir */\n\tmkdir(path: string): void {\n\t\treturn _private.get(this)!.php!.mkdir(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.mkdirTree */\n\tmkdirTree(path: string): void {\n\t\treturn _private.get(this)!.php!.mkdirTree(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.readFileAsText */\n\treadFileAsText(path: string): string {\n\t\treturn _private.get(this)!.php!.readFileAsText(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.readFileAsBuffer */\n\treadFileAsBuffer(path: string): Uint8Array {\n\t\treturn _private.get(this)!.php!.readFileAsBuffer(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.writeFile */\n\twriteFile(path: string, data: string | Uint8Array): void {\n\t\treturn _private.get(this)!.php!.writeFile(path, data);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.unlink */\n\tunlink(path: string): void {\n\t\treturn _private.get(this)!.php!.unlink(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.listFiles */\n\tlistFiles(path: string, options?: ListFilesOptions): string[] {\n\t\treturn _private.get(this)!.php!.listFiles(path, options);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.isDir */\n\tisDir(path: string): boolean {\n\t\treturn _private.get(this)!.php!.isDir(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.isFile */\n\tisFile(path: string): boolean {\n\t\treturn _private.get(this)!.php!.isFile(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.fileExists */\n\tfileExists(path: string): boolean {\n\t\treturn _private.get(this)!.php!.fileExists(path);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.onMessage */\n\tonMessage(listener: MessageListener) {\n\t\treturn _private.get(this)!.php!.onMessage(listener);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.defineConstant */\n\tdefineConstant(key: string, value: string | boolean | number | null): void {\n\t\t_private.get(this)!.php!.defineConstant(key, value);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.addEventListener */\n\taddEventListener(\n\t\teventType: PHPEvent['type'],\n\t\tlistener: PHPEventListener\n\t): void {\n\t\t_private.get(this)!.php!.addEventListener(eventType, listener);\n\t}\n\n\t/** @inheritDoc @php-wasm/universal!/PHP.removeEventListener */\n\tremoveEventListener(\n\t\teventType: PHPEvent['type'],\n\t\tlistener: PHPEventListener\n\t): void {\n\t\t_private.get(this)!.php!.removeEventListener(eventType, listener);\n\t}\n\n\tasync [Symbol.asyncDispose]() {\n\t\tawait _private.get(this)!.requestHandler?.[Symbol.asyncDispose]();\n\t}\n}\n","/*\n * This type is used in Comlink.transferHandlers.set('PHPResponse', { ... })\n * so be sure to update that if you change this type.\n */\nexport interface PHPResponseData {\n\t/**\n\t * Response headers.\n\t */\n\treadonly headers: Record<string, string[]>;\n\n\t/**\n\t * Response body. Contains the output from `echo`,\n\t * `print`, inline HTML etc.\n\t */\n\treadonly bytes: Uint8Array;\n\n\t/**\n\t * Stderr contents, if any.\n\t */\n\treadonly errors: string;\n\n\t/**\n\t * The exit code of the script. `0` is a success, while\n\t * `1` and `2` indicate an error.\n\t */\n\treadonly exitCode: number;\n\n\t/**\n\t * Response HTTP status code, e.g. 200.\n\t */\n\treadonly httpStatusCode: number;\n}\n\nconst responseTexts: Record<number, string> = {\n\t500: 'Internal Server Error',\n\t502: 'Bad Gateway',\n\t404: 'Not Found',\n\t403: 'Forbidden',\n\t401: 'Unauthorized',\n\t400: 'Bad Request',\n\t301: 'Moved Permanently',\n\t302: 'Found',\n\t307: 'Temporary Redirect',\n\t308: 'Permanent Redirect',\n\t204: 'No Content',\n\t201: 'Created',\n\t200: 'OK',\n};\n\nexport class StreamedPHPResponse {\n\t/**\n\t * Response headers.\n\t */\n\tprivate readonly headersStream: ReadableStream<Uint8Array>;\n\n\t/**\n\t * Response body. Contains the output from `echo`,\n\t * `print`, inline HTML etc.\n\t */\n\treadonly stdout: ReadableStream<Uint8Array>;\n\n\t/**\n\t * Stderr contents, if any.\n\t */\n\treadonly stderr: ReadableStream<Uint8Array>;\n\n\t/**\n\t * The exit code of the script. `0` is a success, anything\n\t * else is an error.\n\t */\n\treadonly exitCode: Promise<number>;\n\n\tprivate parsedHeaders: Promise<{\n\t\theaders: Record<string, string[]>;\n\t\thttpStatusCode: number;\n\t}> | null = null;\n\n\tprivate cachedStdoutText: Promise<string> | null = null;\n\tprivate cachedStderrText: Promise<string> | null = null;\n\n\tconstructor(\n\t\theaders: ReadableStream<Uint8Array>,\n\t\tstdout: ReadableStream<Uint8Array>,\n\t\tstderr: ReadableStream<Uint8Array>,\n\t\texitCode: Promise<number>\n\t) {\n\t\tthis.headersStream = headers;\n\t\tthis.stdout = stdout;\n\t\tthis.stderr = stderr;\n\t\tthis.exitCode = exitCode;\n\t}\n\n\t/**\n\t * True if the response is successful (HTTP status code 200-399),\n\t * false otherwise.\n\t */\n\tasync ok(): Promise<boolean> {\n\t\ttry {\n\t\t\tconst statusCode = await this.httpStatusCode;\n\t\t\treturn statusCode >= 200 && statusCode < 400;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Resolves when the response has finished processing – either successfully or not.\n\t */\n\tget finished(): Promise<void> {\n\t\treturn Promise.allSettled([this.exitCode.finally(() => {})]).then(\n\t\t\t() => {}\n\t\t);\n\t}\n\n\t/**\n\t * Resolves once HTTP headers are available.\n\t */\n\tget headers(): Promise<Record<string, string[]>> {\n\t\treturn this.getParsedHeaders().then((headers) => headers.headers);\n\t}\n\n\t/**\n\t * Resolves once HTTP status code is available.\n\t */\n\tget httpStatusCode(): Promise<number> {\n\t\treturn Promise.race([\n\t\t\tthis.getParsedHeaders().then((headers) => headers.httpStatusCode),\n\t\t\tthis.exitCode.then((exitCode) =>\n\t\t\t\texitCode !== 0 ? 500 : undefined\n\t\t\t),\n\t\t])\n\t\t\t.then((result) => {\n\t\t\t\tif (result !== undefined) {\n\t\t\t\t\treturn result;\n\t\t\t\t}\n\t\t\t\t// If exit code is 0 or not available yet, fall back to parsed headers\n\t\t\t\treturn this.getParsedHeaders().then(\n\t\t\t\t\t(headers) => headers.httpStatusCode,\n\t\t\t\t\t() => 200\n\t\t\t\t);\n\t\t\t})\n\t\t\t.catch(() => 500);\n\t}\n\n\t/**\n\t * Exposes the stdout bytes as they're produced by the PHP instance\n\t */\n\tget stdoutText(): Promise<string> {\n\t\tif (!this.cachedStdoutText) {\n\t\t\tthis.cachedStdoutText = streamToText(this.stdout);\n\t\t}\n\t\treturn this.cachedStdoutText;\n\t}\n\n\t/**\n\t * Exposes the stderr bytes as they're produced by the PHP instance\n\t */\n\tget stderrText(): Promise<string> {\n\t\tif (!this.cachedStderrText) {\n\t\t\tthis.cachedStderrText = streamToText(this.stderr);\n\t\t}\n\t\treturn this.cachedStderrText;\n\t}\n\n\tprivate async getParsedHeaders() {\n\t\tif (!this.parsedHeaders) {\n\t\t\tthis.parsedHeaders = parseHeadersStream(this.headersStream);\n\t\t}\n\t\treturn await this.parsedHeaders;\n\t}\n}\n\nasync function parseHeadersStream(\n\theadersStream: ReadableStream<Uint8Array>\n): Promise<{\n\theaders: Record<string, string[]>;\n\thttpStatusCode: number;\n}> {\n\tconst headersText = await streamToText(headersStream);\n\tlet headersData;\n\ttry {\n\t\theadersData = JSON.parse(headersText);\n\t} catch {\n\t\treturn { headers: {}, httpStatusCode: 200 };\n\t}\n\tconst headers: PHPResponse['headers'] = {};\n\tfor (const line of headersData.headers) {\n\t\t// Skip invalid response headers and the last \"__terminator__\" line.\n\t\t// @TODO: Should we log a warning on an invalid header line?\n\t\t//        What's the typical browser behavior when encountering such a line?\n\t\tif (!line.includes(': ')) {\n\t\t\tcontinue;\n\t\t}\n\t\tconst colonIndex = line.indexOf(': ');\n\t\tconst headerName = line.substring(0, colonIndex).toLowerCase();\n\t\tconst headerValue = line.substring(colonIndex + 2);\n\t\tif (!(headerName in headers)) {\n\t\t\theaders[headerName] = [] as string[];\n\t\t}\n\t\theaders[headerName].push(headerValue);\n\t}\n\treturn {\n\t\theaders,\n\t\thttpStatusCode: headersData.status,\n\t};\n}\n\nasync function streamToText(\n\tstream: ReadableStream<Uint8Array>\n): Promise<string> {\n\tconst reader = (stream as ReadableStream<BufferSource>)\n\t\t.pipeThrough(new TextDecoderStream())\n\t\t.getReader();\n\tconst text: string[] = [];\n\twhile (true) {\n\t\tconst { done, value } = await reader.read();\n\t\tif (done) {\n\t\t\treturn text.join('');\n\t\t}\n\t\tif (value) {\n\t\t\ttext.push(value);\n\t\t}\n\t}\n}\n\n/**\n * PHP response. Body is an `ArrayBuffer` because it can\n * contain binary data.\n *\n * This type is used in Comlink.transferHandlers.set('PHPResponse', \\{ ... \\})\n * so be sure to update that if you change this type.\n */\nexport class PHPResponse implements PHPResponseData {\n\t/** @inheritDoc */\n\treadonly headers: Record<string, string[]>;\n\n\t/** @inheritDoc */\n\treadonly bytes: Uint8Array;\n\n\t/** @inheritDoc */\n\treadonly errors: string;\n\n\t/** @inheritDoc */\n\treadonly exitCode: number;\n\n\t/** @inheritDoc */\n\treadonly httpStatusCode: number;\n\n\tconstructor(\n\t\thttpStatusCode: number,\n\t\theaders: Record<string, string[]>,\n\t\tbody: Uint8Array,\n\t\terrors = '',\n\t\texitCode = 0\n\t) {\n\t\tthis.httpStatusCode = httpStatusCode;\n\t\tthis.headers = headers;\n\t\tthis.bytes = body;\n\t\tthis.exitCode = exitCode;\n\t\tthis.errors = errors;\n\t}\n\n\tstatic forHttpCode(httpStatusCode: number, text = '') {\n\t\treturn new PHPResponse(\n\t\t\thttpStatusCode,\n\t\t\t{},\n\t\t\tnew TextEncoder().encode(\n\t\t\t\ttext || responseTexts[httpStatusCode] || ''\n\t\t\t)\n\t\t);\n\t}\n\n\tstatic fromRawData(data: PHPResponseData): PHPResponse {\n\t\treturn new PHPResponse(\n\t\t\tdata.httpStatusCode,\n\t\t\tdata.headers,\n\t\t\tdata.bytes,\n\t\t\tdata.errors,\n\t\t\tdata.exitCode\n\t\t);\n\t}\n\n\tstatic async fromStreamedResponse(\n\t\tstreamedResponse: StreamedPHPResponse\n\t): Promise<PHPResponse> {\n\t\tawait streamedResponse.finished;\n\t\treturn new PHPResponse(\n\t\t\tawait streamedResponse.httpStatusCode,\n\t\t\tawait streamedResponse.headers,\n\t\t\tnew TextEncoder().encode(await streamedResponse.stdoutText),\n\t\t\tawait streamedResponse.stderrText,\n\t\t\tawait streamedResponse.exitCode\n\t\t);\n\t}\n\n\ttoRawData(): PHPResponseData {\n\t\treturn {\n\t\t\theaders: this.headers,\n\t\t\tbytes: this.bytes,\n\t\t\terrors: this.errors,\n\t\t\texitCode: this.exitCode,\n\t\t\thttpStatusCode: this.httpStatusCode,\n\t\t};\n\t}\n\n\t/**\n\t * Response body as JSON.\n\t */\n\tget json() {\n\t\treturn JSON.parse(this.text);\n\t}\n\n\t/**\n\t * Response body as text.\n\t */\n\tget text() {\n\t\treturn new TextDecoder().decode(this.bytes);\n\t}\n}\n","import { logger } from '@php-wasm/logger';\nimport type { IncomingMessage, Server, ServerResponse } from 'http';\n\nconst RuntimeId = Symbol('RuntimeId');\nconst loadedRuntimes: Map<number, PHPRuntime> = new Map();\nlet lastRuntimeId = 0;\n\n/**\n * Loads the PHP runtime with the given arguments and data dependencies.\n *\n * This function handles the entire PHP initialization pipeline. In particular,\n * it:\n *\n * * Instantiates the Emscripten PHP module\n * * Wires it together with the data dependencies and loads them\n * * Ensures is all happens in a correct order\n * * Waits until the entire loading sequence is finished\n *\n * Basic usage:\n *\n * ```js\n *  const phpLoaderModule = await getPHPLoaderModule(\"7.4\");\n *  const php = await loadPHPRuntime( phpLoaderModule );\n *  console.log(php.run(`<?php echo \"Hello, world!\"; `));\n *  // { stdout: ArrayBuffer containing the string \"Hello, world!\", stderr: [''], exitCode: 0 }\n * ```\n *\n * **The PHP loader module:**\n *\n * In the basic usage example, `phpLoaderModule` is **not** a vanilla\n * Emscripten module. Instead, it's an ESM module that wraps the regular\n * Emscripten output and adds some extra functionality. It's generated by the\n * Dockerfile shipped with this repo. Here's the API it provides:\n *\n * ```js\n * // php.wasm size in bytes:\n * export const dependenciesTotalSize = 5644199;\n *\n * // php.wasm filename:\n * export const dependencyFilename = 'php.wasm';\n *\n * // Run Emscripten's generated module:\n * export default function(jsEnv, emscriptenModuleArgs) {}\n * ```\n *\n * **PHP Filesystem:**\n *\n * Once initialized, the PHP has its own filesystem separate from the project\n * files. It's provided by [Emscripten and uses its FS library](https://emscripten.org/docs/api_reference/Filesystem-API.html).\n *\n * The API exposed to you via the PHP class is succinct and abstracts\n * certain unintuitive parts of low-level filesystem interactions.\n *\n * Here's how to use it:\n *\n * ```js\n * // Recursively create a /var/www directory\n * php.mkdirTree('/var/www');\n *\n * console.log(php.fileExists('/var/www/file.txt'));\n * // false\n *\n * php.writeFile('/var/www/file.txt', 'Hello from the filesystem!');\n *\n * console.log(php.fileExists('/var/www/file.txt'));\n * // true\n *\n * console.log(php.readFile('/var/www/file.txt'));\n * // \"Hello from the filesystem!\n *\n * // Delete the file:\n * php.unlink('/var/www/file.txt');\n * ```\n *\n * For more details consult the PHP class directly.\n *\n * **Data dependencies:**\n *\n * Using existing PHP packages by manually recreating them file-by-file would\n * be quite inconvenient. Fortunately, Emscripten provides a \"data dependencies\"\n * feature.\n *\n * Data dependencies consist of a `dependency.data` file and a `dependency.js`\n * loader and can be packaged with the [file_packager.py tool](\n * https://emscripten.org/docs/porting/files/packaging_files.html#packaging-using-the-file-packager-tool).\n * This project requires wrapping the Emscripten-generated `dependency.js` file\n * in an ES module as follows:\n *\n * 1. Prepend `export default function(emscriptenPHPModule) {'; `\n * 2. Prepend `export const dependencyFilename = '<DATA FILE NAME>'; `\n * 3. Prepend `export const dependenciesTotalSize = <DATA FILE SIZE>;`\n * 4. Append `}`\n *\n * Be sure to use the `--export-name=\"emscriptenPHPModule\"` file_packager.py\n * option.\n *\n * You want the final output to look as follows:\n *\n * ```js\n * export const dependenciesTotalSize = 5644199;\n * export const dependencyFilename = 'dependency.data';\n * export default function(emscriptenPHPModule) {\n *    // Emscripten-generated code:\n *    var Module = typeof emscriptenPHPModule !== 'undefined' ? emscriptenPHPModule : {};\n *    // ... the rest of it ...\n * }\n * ```\n *\n * Such a constructions enables loading the `dependency.js` as an ES Module\n * using `import(\"/dependency.js\")`.\n *\n * Once it's ready, you can load PHP and your data dependencies as follows:\n *\n * ```js\n *  const [phpLoaderModule, wordPressLoaderModule] = await Promise.all([\n *    getPHPLoaderModule(\"7.4\"),\n *    import(\"/wp.js\")\n *  ]);\n *  const php = await loadPHPRuntime(phpLoaderModule, {}, [wordPressLoaderModule]);\n * ```\n *\n * @public\n * @param  phpLoaderModule         - The ESM-wrapped Emscripten module. Consult the Dockerfile for the build process.\n * @param  options                 - The Emscripten module arguments, see https://emscripten.org/docs/api_reference/module.html#affecting-execution.\n * @returns Loaded runtime id.\n */\n\nexport async function loadPHPRuntime(\n\tphpLoaderModule: PHPLoaderModule,\n\t...options: EmscriptenOptions[]\n): Promise<number> {\n\tconst phpModuleArgs = Object.assign({}, ...options);\n\n\tconst [phpReady, resolvePHP, rejectPHP] = makePromise();\n\n\tconst PHPRuntime = phpLoaderModule.init(currentJsRuntime, {\n\t\tonAbort(reason) {\n\t\t\trejectPHP(reason);\n\t\t\t// This can happen after PHP has been initialized so\n\t\t\t// let's just log it.\n\t\t\tlogger.error(reason);\n\t\t},\n\t\tENV: {},\n\t\t// Emscripten sometimes prepends a '/' to the path, which\n\t\t// breaks vite dev mode. An identity `locateFile` function\n\t\t// fixes it.\n\t\tlocateFile: (path) => path,\n\t\t...phpModuleArgs,\n\t\tnoInitialRun: true,\n\t\tonRuntimeInitialized() {\n\t\t\tif (phpModuleArgs.onRuntimeInitialized) {\n\t\t\t\tphpModuleArgs.onRuntimeInitialized(PHPRuntime);\n\t\t\t}\n\t\t\tresolvePHP();\n\t\t},\n\t});\n\n\tawait phpReady;\n\n\tconst id = ++lastRuntimeId;\n\n\t// TODO: Ask @adamziel why this is here.\n\t// eslint-disable-next-line @typescript-eslint/no-unused-expressions -- why is this here?\n\tPHPRuntime.FS;\n\tPHPRuntime.id = id;\n\tPHPRuntime.originalExit = PHPRuntime._exit;\n\n\tPHPRuntime._exit = function (code: number) {\n\t\tif (PHPRuntime.outboundNetworkProxyServer) {\n\t\t\tPHPRuntime.outboundNetworkProxyServer.close();\n\t\t\tPHPRuntime.outboundNetworkProxyServer.closeAllConnections();\n\t\t}\n\t\tloadedRuntimes.delete(id);\n\t\treturn PHPRuntime.originalExit(code);\n\t};\n\n\tPHPRuntime[RuntimeId] = id;\n\tloadedRuntimes.set(id, PHPRuntime);\n\treturn id;\n}\n\nexport type RuntimeType = 'NODE' | 'WEB' | 'WORKER';\n\ndeclare const self: WindowOrWorkerGlobalScope;\ndeclare const WorkerGlobalScope: object | undefined;\n\nexport type PHPRuntimeId = number;\n\nexport function getLoadedRuntime(id: PHPRuntimeId): PHPRuntime {\n\treturn loadedRuntimes.get(id);\n}\n\nexport const currentJsRuntime = (function () {\n\tif (typeof process !== 'undefined' && process.release?.name === 'node') {\n\t\treturn 'NODE';\n\t} else if (typeof window !== 'undefined') {\n\t\treturn 'WEB';\n\t} else if (\n\t\ttypeof WorkerGlobalScope !== 'undefined' &&\n\t\tself instanceof (WorkerGlobalScope as any)\n\t) {\n\t\treturn 'WORKER';\n\t} else {\n\t\treturn 'NODE';\n\t}\n})();\n\n/**\n * Creates and exposes Promise resolve/reject methods for later use.\n */\nconst makePromise = () => {\n\tconst methods: any = [];\n\n\tconst promise = new Promise((resolve, reject) => {\n\t\tmethods.push(resolve, reject);\n\t});\n\tmethods.unshift(promise);\n\n\treturn methods as [Promise<any>, (v?: any) => void, (e?: any) => void];\n};\n\nexport type PHPRuntime = any;\n\nexport type PHPLoaderModule = {\n\tdependencyFilename: string;\n\tdependenciesTotalSize: number;\n\tinit: (jsRuntime: string, options: EmscriptenOptions) => PHPRuntime;\n};\n\nexport type DataModule = {\n\tdependencyFilename: string;\n\tdependenciesTotalSize: number;\n\tdefault: (phpRuntime: PHPRuntime) => void;\n};\n\nexport type EmscriptenOptions = {\n\tonAbort?: (message: string) => void;\n\t/**\n\t * Set to true for debugging tricky WebAssembly errors.\n\t */\n\tdebug?: boolean;\n\tENV?: Record<string, string>;\n\tlocateFile?: (path: string) => string;\n\tnoInitialRun?: boolean;\n\tprint?: (message: string) => void;\n\tprintErr?: (message: string) => void;\n\tquit?: (status: number, toThrow: any) => void;\n\tonRuntimeInitialized?: (phpRuntime: PHPRuntime) => void;\n\tmonitorRunDependencies?: (left: number) => void;\n\tonMessage?: (listener: EmscriptenMessageListener) => void;\n\toutboundNetworkProxyServer?: Server<\n\t\ttypeof IncomingMessage,\n\t\ttypeof ServerResponse\n\t>;\n\tinstantiateWasm?: (\n\t\tinfo: WebAssembly.Imports,\n\t\treceiveInstance: (\n\t\t\tinstance: WebAssembly.Instance,\n\t\t\tmodule: WebAssembly.Module\n\t\t) => void\n\t) => void;\n} & Record<string, any>;\n\nexport type EmscriptenMessageListener = (type: string, data: string) => void;\n","/*\n * Node.js Polyfill for ErrorEvent.\n */\n\nconst kError = Symbol('error');\nconst kMessage = Symbol('message');\n\ninterface ErrorEventOptions {\n\t/* The error that generated this event */\n\terror?: Error;\n\t/* The error message */\n\tmessage?: string;\n}\n/**\n * Class representing an error event.\n *\n * @extends Event\n */\nclass ErrorEvent2 extends Event {\n\t[kError]: any;\n\t[kMessage]: any;\n\t/**\n\t * Create a new `ErrorEvent`.\n\t *\n\t * @param type The name of the event\n\t * @param options A dictionary object that allows for setting\n\t *                  attributes via object members of the same name.\n\t */\n\tconstructor(type: 'error', options: ErrorEventOptions = {}) {\n\t\tsuper(type);\n\n\t\tthis[kError] = options.error === undefined ? null : options.error;\n\t\tthis[kMessage] = options.message === undefined ? '' : options.message;\n\t}\n\n\tget error() {\n\t\treturn this[kError];\n\t}\n\n\tget message() {\n\t\treturn this[kMessage];\n\t}\n}\nObject.defineProperty(ErrorEvent2.prototype, 'error', { enumerable: true });\nObject.defineProperty(ErrorEvent2.prototype, 'message', { enumerable: true });\n\nexport const ErrorEvent =\n\ttypeof globalThis.ErrorEvent === 'function'\n\t\t? globalThis.ErrorEvent\n\t\t: ErrorEvent2;\n","/**\n * Check if the Emscripten-thrown error is an exit code 0 error.\n *\n * @param e The error to check\n * @returns True if the error appears to represent an exit code or status\n */\nexport function isExitCode(e: any): e is { exitCode: number } {\n\tif (!(e instanceof Error)) {\n\t\treturn false;\n\t}\n\treturn 'exitCode' in e || (e?.name === 'ExitStatus' && 'status' in e);\n}\n","import { ErrorEvent } from './error-event-polyfill';\nimport { isExitCode } from './is-exit-code';\nimport { logger } from '@php-wasm/logger';\n\ntype Runtime = {\n\twasmExports: Record<string, unknown>;\n\tlastAsyncifyStackSource?: Error;\n};\n\nexport class UnhandledRejectionsTarget extends EventTarget {\n\tlistenersCount = 0;\n\toverride addEventListener(\n\t\ttype: unknown,\n\t\tcallback: unknown,\n\t\toptions?: boolean | AddEventListenerOptions\n\t): void {\n\t\t++this.listenersCount;\n\t\tsuper.addEventListener(\n\t\t\ttype as string,\n\t\t\tcallback as EventListener,\n\t\t\toptions\n\t\t);\n\t}\n\toverride removeEventListener(\n\t\ttype: unknown,\n\t\tcallback: unknown,\n\t\toptions?: boolean | EventListenerOptions\n\t): void {\n\t\t--this.listenersCount;\n\t\tsuper.removeEventListener(\n\t\t\ttype as string,\n\t\t\tcallback as EventListener,\n\t\t\toptions\n\t\t);\n\t}\n\thasListeners() {\n\t\treturn this.listenersCount > 0;\n\t}\n}\n\n/**\n * Creates Asyncify errors listener.\n *\n * Emscripten turns Asyncify errors into unhandled rejections by\n * throwing them outside of the context of the original function call.\n *\n * With this listener, we can catch and rethrow them in a proper context,\n * or at least log them in a more readable way.\n *\n * @param runtime\n */\nexport function improveWASMErrorReporting(runtime: Runtime) {\n\tconst target = new UnhandledRejectionsTarget();\n\tfor (const key in runtime.wasmExports) {\n\t\tif (typeof runtime.wasmExports[key] == 'function') {\n\t\t\tconst original = runtime.wasmExports[key] as any;\n\t\t\truntime.wasmExports[key] = function (...args: any[]) {\n\t\t\t\ttry {\n\t\t\t\t\treturn original(...args);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (!(e instanceof Error)) {\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (runtime.lastAsyncifyStackSource) {\n\t\t\t\t\t\te.cause = runtime.lastAsyncifyStackSource;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst clearMessage = clarifyErrorMessage(\n\t\t\t\t\t\te,\n\t\t\t\t\t\truntime.lastAsyncifyStackSource?.stack\n\t\t\t\t\t);\n\n\t\t\t\t\tif (target.hasListeners()) {\n\t\t\t\t\t\tconst event = new ErrorEvent('error', {\n\t\t\t\t\t\t\terror: e,\n\t\t\t\t\t\t\tmessage: clearMessage,\n\t\t\t\t\t\t});\n\t\t\t\t\t\ttarget.dispatchEvent(event);\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!isExitCode(e) || e.exitCode !== 0) {\n\t\t\t\t\t\tshowCriticalErrorBox(clearMessage);\n\t\t\t\t\t}\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n\treturn target;\n}\n\nlet functionsMaybeMissingFromAsyncify: string[] = [];\nexport function getFunctionsMaybeMissingFromAsyncify() {\n\treturn functionsMaybeMissingFromAsyncify;\n}\n\nexport function clarifyErrorMessage(\n\tcrypticError: Error,\n\tasyncifyStack?: string\n) {\n\tif (crypticError.message === 'unreachable') {\n\t\tlet betterMessage = UNREACHABLE_ERROR;\n\t\tif (!asyncifyStack) {\n\t\t\tbetterMessage +=\n\t\t\t\t`\\n\\nThis stack trace is lacking. For a better one initialize \\n` +\n\t\t\t\t`the PHP runtime with { debug: true }, e.g. PHPNode.load('8.1', { debug: true }).\\n\\n`;\n\t\t}\n\n\t\t// Extract all the PHP functions from the entire error chain.\n\t\tconst uniqueFunctions = new Set<string>(\n\t\t\textractPHPFunctionsFromStack(asyncifyStack || '')\n\t\t);\n\t\tlet lastError = crypticError;\n\t\tdo {\n\t\t\tfor (const fn of extractPHPFunctionsFromStack(\n\t\t\t\tlastError.stack || ''\n\t\t\t)) {\n\t\t\t\tuniqueFunctions.add(fn);\n\t\t\t}\n\t\t\tlastError = lastError.cause as Error;\n\t\t} while (lastError);\n\t\tfunctionsMaybeMissingFromAsyncify = Array.from(uniqueFunctions);\n\n\t\tfor (const fn of uniqueFunctions) {\n\t\t\tbetterMessage += `    * ${fn}\\n`;\n\t\t}\n\n\t\treturn betterMessage;\n\t}\n\treturn crypticError.message;\n}\n\nconst UNREACHABLE_ERROR = `\n\"unreachable\" WASM instruction executed.\n\nThe typical reason is a PHP function missing from the ASYNCIFY_ONLY\nlist when building PHP.wasm.\n\nYou will need to file a new issue in the WordPress Playground repository\nand paste this error message there:\n\nhttps://github.com/WordPress/wordpress-playground/issues/new\n\nIf you're a core developer, the typical fix is to:\n\n* Isolate a minimal reproduction of the error\n* Add a reproduction of the error to php-asyncify.spec.ts in the WordPress Playground repository\n* Run 'npm run fix-asyncify'\n* Commit the changes, push to the repo, release updated NPM packages\n\nBelow is a list of all the PHP functions found in the stack trace to\nhelp with the minimal reproduction. If they're all already listed in\nthe Dockerfile, you'll need to trigger this error again with long stack\ntraces enabled. In node.js, you can do it using the --stack-trace-limit=100\nCLI option: \\n\\n`;\n\n// ANSI escape codes for CLI colors and formats\nconst redBg = '\\x1b[41m';\nconst bold = '\\x1b[1m';\nconst reset = '\\x1b[0m';\nconst eol = '\\x1B[K';\n\nlet logged = false;\nexport function showCriticalErrorBox(message: string) {\n\tif (logged) {\n\t\treturn;\n\t}\n\tlogged = true;\n\tif (message?.trim().startsWith('Program terminated with exit')) {\n\t\treturn;\n\t}\n\tlogger.log(`${redBg}\\n${eol}\\n${bold}  WASM ERROR${reset}${redBg}`);\n\tfor (const line of message.split('\\n')) {\n\t\tlogger.log(`${eol}  ${line} `);\n\t}\n\tlogger.log(`${reset}`);\n}\n\nfunction extractPHPFunctionsFromStack(stack: string) {\n\ttry {\n\t\tconst names = stack\n\t\t\t.split('\\n')\n\t\t\t.slice(1)\n\t\t\t.map((line) => {\n\t\t\t\tconst parts = line.trim().substring('at '.length).split(' ');\n\t\t\t\treturn {\n\t\t\t\t\tfn: parts.length >= 2 ? parts[0] : '<unknown>',\n\t\t\t\t\tisWasm: line.includes('wasm:/'),\n\t\t\t\t};\n\t\t\t})\n\t\t\t.filter(\n\t\t\t\t({ fn, isWasm }) =>\n\t\t\t\t\tisWasm &&\n\t\t\t\t\t!fn.startsWith('dynCall_') &&\n\t\t\t\t\t!fn.startsWith('invoke_')\n\t\t\t)\n\t\t\t.map(({ fn }) => fn);\n\t\treturn Array.from(new Set(names));\n\t} catch {\n\t\treturn [];\n\t}\n}\n","import { PHPResponse, StreamedPHPResponse } from './php-response';\nimport { getLoadedRuntime } from './load-php-runtime';\nimport type { PHPRuntimeId } from './load-php-runtime';\nimport type {\n\tMessageListener,\n\tPHPRequest,\n\tPHPRequestHeaders,\n\tPHPRunOptions,\n\tSpawnHandler,\n\tPHPEventListener,\n\tPHPEvent,\n} from './universal-php';\nimport type { RmDirOptions, ListFilesOptions } from './fs-helpers';\nimport { FSHelpers } from './fs-helpers';\nimport type { UnhandledRejectionsTarget } from './wasm-error-reporting';\nimport {\n\tgetFunctionsMaybeMissingFromAsyncify,\n\timproveWASMErrorReporting,\n} from './wasm-error-reporting';\nimport { Semaphore, createSpawnHandler, joinPaths } from '@php-wasm/util';\nimport type { PHPRequestHandler } from './php-request-handler';\nimport { logger } from '@php-wasm/logger';\nimport { isExitCode } from './is-exit-code';\nimport type { Emscripten } from './emscripten-types';\n\nconst STRING = 'string';\nconst NUMBER = 'number';\n\nexport const __private__dont__use = Symbol('__private__dont__use');\n\ntype ErrorSource = 'request' | 'php-wasm';\nexport class PHPExecutionFailureError extends Error {\n\tresponse: PHPResponse;\n\tsource: ErrorSource;\n\n\tconstructor(message: string, response: PHPResponse, source: ErrorSource) {\n\t\tsuper(message);\n\t\tthis.response = response;\n\t\tthis.source = source;\n\t}\n}\n\nexport type UnmountFunction = (() => Promise<any>) | (() => any);\nexport type MountHandler = (\n\tphp: PHP,\n\tFS: Emscripten.RootFS,\n\tvfsMountPoint: string\n) => UnmountFunction | Promise<UnmountFunction>;\n\nexport const PHP_INI_PATH = '/internal/shared/php.ini';\nconst AUTO_PREPEND_SCRIPT = '/internal/shared/auto_prepend_file.php';\n\ntype MountObject = {\n\tmountHandler: MountHandler;\n\tunmount: () => Promise<any>;\n};\n\n/**\n * An environment-agnostic wrapper around the Emscripten PHP runtime\n * that universals the super low-level API and provides a more convenient\n * higher-level API.\n *\n * It exposes a minimal set of methods to run PHP scripts and to\n * interact with the PHP filesystem.\n */\nexport class PHP implements Disposable {\n\tprotected [__private__dont__use]: any;\n\t#sapiName?: string;\n\t#webSapiInitialized = false;\n\t#wasmErrorsTarget: UnhandledRejectionsTarget | null = null;\n\t#eventListeners: Map<string, Set<PHPEventListener>> = new Map();\n\t#messageListeners: MessageListener[] = [];\n\t#mounts: Record<string, MountObject> = {};\n\trequestHandler?: PHPRequestHandler;\n\n\t/**\n\t * An exclusive lock that prevent multiple requests from running at\n\t * the same time.\n\t */\n\tsemaphore: Semaphore;\n\n\t/**\n\t * Initializes a PHP runtime.\n\t *\n\t * @internal\n\t * @param  PHPRuntime - Optional. PHP Runtime ID as initialized by loadPHPRuntime.\n\t * @param  requestHandlerOptions - Optional. Options for the PHPRequestHandler. If undefined, no request handler will be initialized.\n\t */\n\tconstructor(PHPRuntimeId?: PHPRuntimeId) {\n\t\tthis.semaphore = new Semaphore({ concurrency: 1 });\n\t\tif (PHPRuntimeId !== undefined) {\n\t\t\tthis.initializeRuntime(PHPRuntimeId);\n\t\t}\n\t}\n\n\t/**\n\t * Adds an event listener for a PHP event.\n\t * @param eventType - The type of event to listen for.\n\t * @param listener - The listener function to be called when the event is triggered.\n\t */\n\taddEventListener(eventType: PHPEvent['type'], listener: PHPEventListener) {\n\t\tif (!this.#eventListeners.has(eventType)) {\n\t\t\tthis.#eventListeners.set(eventType, new Set());\n\t\t}\n\t\tthis.#eventListeners.get(eventType)!.add(listener);\n\t}\n\n\t/**\n\t * Removes an event listener for a PHP event.\n\t * @param eventType - The type of event to remove the listener from.\n\t * @param listener - The listener function to be removed.\n\t */\n\tremoveEventListener(\n\t\teventType: PHPEvent['type'],\n\t\tlistener: PHPEventListener\n\t) {\n\t\tthis.#eventListeners.get(eventType)?.delete(listener);\n\t}\n\n\tdispatchEvent<Event extends PHPEvent>(event: Event) {\n\t\tconst listeners = this.#eventListeners.get(event.type);\n\t\tif (!listeners) {\n\t\t\treturn;\n\t\t}\n\n\t\tfor (const listener of listeners) {\n\t\t\tlistener(event);\n\t\t}\n\t}\n\n\t/**\n\t * Listens to message sent by the PHP code.\n\t *\n\t * To dispatch messages, call:\n\t *\n\t *     post_message_to_js(string $data)\n\t *\n\t *     Arguments:\n\t *         $data (string) – Data to pass to JavaScript.\n\t *\n\t * @example\n\t *\n\t * ```ts\n\t * const php = await PHP.load('8.0');\n\t *\n\t * php.onMessage(\n\t *     // The data is always passed as a string\n\t *     function (data: string) {\n\t *         // Let's decode and log the data:\n\t *         console.log(JSON.parse(data));\n\t *     }\n\t * );\n\t *\n\t * // Now that we have a listener in place, let's\n\t * // dispatch a message:\n\t * await php.run({\n\t *     code: `<?php\n\t *         post_message_to_js(\n\t *             json_encode([\n\t *                 'post_id' => '15',\n\t *                 'post_title' => 'This is a blog post!'\n\t *             ])\n\t *         ));\n\t *     `,\n\t * });\n\t * ```\n\t *\n\t * @param listener Callback function to handle the message.\n\t */\n\tonMessage(listener: MessageListener) {\n\t\tthis.#messageListeners.push(listener);\n\t\treturn async () => {\n\t\t\tthis.#messageListeners = this.#messageListeners.filter(\n\t\t\t\t(l) => l !== listener\n\t\t\t);\n\t\t};\n\t}\n\n\tasync setSpawnHandler(handler: SpawnHandler | string) {\n\t\tif (typeof handler === 'string') {\n\t\t\t// This workaround is needed because the\n\t\t\t// Comlink messaging library used by Playground\n\t\t\t// has a hard time serializing a composite\n\t\t\t// handler object.\n\t\t\t// @TODO: Don't eval text-based functions here. Instead\n\t\t\t//        use a MessagePort to communicate with the\n\t\t\t//\t\t  parent context.\n\t\t\t// Perhaps this library would be useful:\n\t\t\t// https://github.com/WebReflection/coincident/\n\t\t\thandler = createSpawnHandler(eval(handler));\n\t\t}\n\t\tthis[__private__dont__use].spawnProcess = handler;\n\t}\n\n\t/** @deprecated Use PHPRequestHandler instead. */\n\tget absoluteUrl() {\n\t\treturn this.requestHandler!.absoluteUrl;\n\t}\n\n\t/** @deprecated Use PHPRequestHandler instead. */\n\tget documentRoot() {\n\t\treturn this.requestHandler!.documentRoot;\n\t}\n\n\t/** @deprecated Use PHPRequestHandler instead. */\n\tpathToInternalUrl(path: string): string {\n\t\treturn this.requestHandler!.pathToInternalUrl(path);\n\t}\n\n\t/** @deprecated Use PHPRequestHandler instead. */\n\tinternalUrlToPath(internalUrl: string): string {\n\t\treturn this.requestHandler!.internalUrlToPath(internalUrl);\n\t}\n\n\tinitializeRuntime(runtimeId: PHPRuntimeId) {\n\t\tif (this[__private__dont__use]) {\n\t\t\tthrow new Error('PHP runtime already initialized.');\n\t\t}\n\t\tconst runtime = getLoadedRuntime(runtimeId);\n\t\tif (!runtime) {\n\t\t\tthrow new Error('Invalid PHP runtime id.');\n\t\t}\n\t\tthis[__private__dont__use] = runtime;\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_phpini_path',\n\t\t\tnull,\n\t\t\t['string'],\n\t\t\t[PHP_INI_PATH]\n\t\t);\n\n\t\tif (!this.fileExists(PHP_INI_PATH)) {\n\t\t\tthis.writeFile(\n\t\t\t\tPHP_INI_PATH,\n\t\t\t\t[\n\t\t\t\t\t'auto_prepend_file=' + AUTO_PREPEND_SCRIPT,\n\t\t\t\t\t'memory_limit=256M',\n\t\t\t\t\t'ignore_repeated_errors = 1',\n\t\t\t\t\t'error_reporting = E_ALL',\n\t\t\t\t\t'display_errors = 1',\n\t\t\t\t\t'html_errors = 1',\n\t\t\t\t\t'display_startup_errors = On',\n\t\t\t\t\t'log_errors = 1',\n\t\t\t\t\t'always_populate_raw_post_data = -1',\n\t\t\t\t\t'upload_max_filesize = 2000M',\n\t\t\t\t\t'post_max_size = 2000M',\n\t\t\t\t\t'allow_url_fopen = On',\n\t\t\t\t\t'allow_url_include = Off',\n\t\t\t\t\t'session.save_path = /home/web_user',\n\t\t\t\t\t'implicit_flush = 1',\n\t\t\t\t\t'output_buffering = 0',\n\t\t\t\t\t'max_execution_time = 0',\n\t\t\t\t\t'max_input_time = -1',\n\t\t\t\t].join('\\n')\n\t\t\t);\n\t\t}\n\t\tif (!this.fileExists(AUTO_PREPEND_SCRIPT)) {\n\t\t\tthis.writeFile(\n\t\t\t\tAUTO_PREPEND_SCRIPT,\n\t\t\t\t`<?php\n\t\t\t\t// Define constants set via defineConstant() calls\n\t\t\t\tif(file_exists('/internal/shared/consts.json')) {\n\t\t\t\t\t$consts = json_decode(file_get_contents('/internal/shared/consts.json'), true);\n\t\t\t\t\tforeach ($consts as $const => $value) {\n\t\t\t\t\t\tif (!defined($const) && is_scalar($value)) {\n\t\t\t\t\t\t\tdefine($const, $value);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Preload all the files from /internal/shared/preload\n\t\t\t\tforeach (glob('/internal/shared/preload/*.php') as $file) {\n\t\t\t\t\trequire_once $file;\n\t\t\t\t}\n\t\t\t\t`\n\t\t\t);\n\t\t}\n\n\t\truntime['onMessage'] = async (\n\t\t\tdata: string\n\t\t): Promise<string | Uint8Array> => {\n\t\t\tfor (const listener of this.#messageListeners) {\n\t\t\t\tconst returnData = await listener(data);\n\n\t\t\t\tif (returnData) {\n\t\t\t\t\treturn returnData;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn '';\n\t\t};\n\n\t\tthis.#wasmErrorsTarget = improveWASMErrorReporting(runtime);\n\t\tthis.dispatchEvent({\n\t\t\ttype: 'runtime.initialized',\n\t\t});\n\t}\n\n\t/** @inheritDoc */\n\tasync setSapiName(newName: string) {\n\t\tconst result = this[__private__dont__use].ccall(\n\t\t\t'wasm_set_sapi_name',\n\t\t\tNUMBER,\n\t\t\t[STRING],\n\t\t\t[newName]\n\t\t);\n\t\tif (result !== 0) {\n\t\t\tthrow new Error(\n\t\t\t\t'Could not set SAPI name. This can only be done before the PHP WASM module is initialized.' +\n\t\t\t\t\t'Did you already dispatch any requests?'\n\t\t\t);\n\t\t}\n\t\tthis.#sapiName = newName;\n\t}\n\n\t/**\n\t * Changes the current working directory in the PHP filesystem.\n\t * This is the directory that will be used as the base for relative paths.\n\t * For example, if the current working directory is `/root/php`, and the\n\t * path is `data`, the absolute path will be `/root/php/data`.\n\t *\n\t * @param  path - The new working directory.\n\t */\n\tchdir(path: string) {\n\t\tthis[__private__dont__use].FS.chdir(path);\n\t}\n\n\t/**\n\t * Do not use. Use new PHPRequestHandler() instead.\n\t * @deprecated\n\t */\n\tasync request(request: PHPRequest): Promise<PHPResponse> {\n\t\tlogger.warn(\n\t\t\t'PHP.request() is deprecated. Please use new PHPRequestHandler() instead.'\n\t\t);\n\t\tif (!this.requestHandler) {\n\t\t\tthrow new Error('No request handler available.');\n\t\t}\n\t\treturn this.requestHandler.request(request);\n\t}\n\n\t/**\n\t * Runs PHP code.\n\t *\n\t * This low-level method directly interacts with the WebAssembly\n\t * PHP interpreter.\n\t *\n\t * Every time you call run(), it prepares the PHP\n\t * environment and:\n\t *\n\t * * Resets the internal PHP state\n\t * * Populates superglobals ($_SERVER, $_GET, etc.)\n\t * * Handles file uploads\n\t * * Populates input streams (stdin, argv, etc.)\n\t * * Sets the current working directory\n\t *\n\t * You can use run() in two primary modes:\n\t *\n\t * ### Code snippet mode\n\t *\n\t * In this mode, you pass a string containing PHP code to run.\n\t *\n\t * ```ts\n\t * const result = await php.run({\n\t * \tcode: `<?php echo \"Hello world!\";`\n\t * });\n\t * // result.text === \"Hello world!\"\n\t * ```\n\t *\n\t * In this mode, information like __DIR__ or __FILE__ isn't very\n\t * useful because the code is not associated with any file.\n\t *\n\t * Under the hood, the PHP snippet is passed to the `zend_eval_string`\n\t * C function.\n\t *\n\t * ### File mode\n\t *\n\t * In the file mode, you pass a scriptPath and PHP executes a file\n\t * found at a that path:\n\t *\n\t * ```ts\n\t * php.writeFile(\n\t * \t\"/www/index.php\",\n\t * \t`<?php echo \"Hello world!\";\"`\n\t * );\n\t * const result = await php.run({\n\t * \tscriptPath: \"/www/index.php\"\n\t * });\n\t * // result.text === \"Hello world!\"\n\t * ```\n\t *\n\t * In this mode, you can rely on path-related information like __DIR__\n\t * or __FILE__.\n\t *\n\t * Under the hood, the PHP file is executed with the `php_execute_script`\n\t * C function.\n\t *\n\t * The `run()` method cannot be used in conjunction with `cli()`.\n\t *\n\t * @example\n\t * ```js\n\t * const result = await php.run({\n\t * \tcode: `<?php\n\t * \t\t$fp = fopen('php://stderr', 'w');\n\t * \t\tfwrite($fp, \"Hello, world!\");\n\t * \t`\n\t * });\n\t * // result.errors === \"Hello, world!\"\n\t * ```\n\t *\n\t * @deprecated Use stream() instead.\n\t * @param  request - PHP runtime options.\n\t */\n\tasync run(request: PHPRunOptions): Promise<PHPResponse> {\n\t\tconst streamedResponse = await this.runStream(request);\n\t\tconst syncResponse = await PHPResponse.fromStreamedResponse(\n\t\t\tstreamedResponse\n\t\t);\n\n\t\tif (syncResponse.exitCode !== 0) {\n\t\t\tlogger.warn(`PHP.run() output was:`, syncResponse.text);\n\t\t\tconst error = new PHPExecutionFailureError(\n\t\t\t\t`PHP.run() failed with exit code ${syncResponse.exitCode} and the following output: ` +\n\t\t\t\t\tsyncResponse.errors +\n\t\t\t\t\t'\\n\\n' +\n\t\t\t\t\tsyncResponse.text,\n\t\t\t\tsyncResponse,\n\t\t\t\t'request'\n\t\t\t) as PHPExecutionFailureError;\n\t\t\tlogger.error(error);\n\t\t\tthis.dispatchEvent({\n\t\t\t\ttype: 'request.error',\n\t\t\t\terror: new Error(\n\t\t\t\t\t'PHP.run() failed with exit code ' + syncResponse.exitCode\n\t\t\t\t),\n\t\t\t\t// Distinguish between PHP request and PHP-wasm errors\n\t\t\t\tsource: 'request',\n\t\t\t});\n\t\t\tthrow error;\n\t\t}\n\n\t\treturn syncResponse;\n\t}\n\t/**\n\t * Runs PHP code and returns a StreamedPHPResponse object that can be used to\n\t * process the output incrementally.\n\t *\n\t * This low-level method directly interacts with the WebAssembly\n\t * PHP interpreter and provides streaming capabilities for processing\n\t * PHP output as it becomes available.\n\t *\n\t * Every time you call stream(), it prepares the PHP\n\t * environment and:\n\t *\n\t * * Resets the internal PHP state\n\t * * Populates superglobals ($_SERVER, $_GET, etc.)\n\t * * Handles file uploads\n\t * * Populates input streams (stdin, argv, etc.)\n\t * * Sets the current working directory\n\t *\n\t * You can use stream() in two primary modes:\n\t *\n\t * ### Code snippet mode\n\t *\n\t * In this mode, you pass a string containing PHP code to run.\n\t *\n\t * ```ts\n\t * const streamedResponse = await php.stream({\n\t * \tcode: `<?php echo \"Hello world!\";`\n\t * });\n\t * // Process output incrementally\n\t * for await (const chunk of streamedResponse.text) {\n\t * \tconsole.log(chunk);\n\t * }\n\t * ```\n\t *\n\t * In this mode, information like __DIR__ or __FILE__ isn't very\n\t * useful because the code is not associated with any file.\n\t *\n\t * Under the hood, the PHP snippet is passed to the `zend_eval_string`\n\t * C function.\n\t *\n\t * ### File mode\n\t *\n\t * In the file mode, you pass a scriptPath and PHP executes a file\n\t * found at that path:\n\t *\n\t * ```ts\n\t * php.writeFile(\n\t * \t\"/www/index.php\",\n\t * \t`<?php echo \"Hello world!\";\"`\n\t * );\n\t * const streamedResponse = await php.stream({\n\t * \tscriptPath: \"/www/index.php\"\n\t * });\n\t * // Process output incrementally\n\t * for await (const chunk of streamedResponse.text) {\n\t * \tconsole.log(chunk);\n\t * }\n\t * ```\n\t *\n\t * In this mode, you can rely on path-related information like __DIR__\n\t * or __FILE__.\n\t *\n\t * Under the hood, the PHP file is executed with the `php_execute_script`\n\t * C function.\n\t *\n\t * The `stream()` method cannot be used in conjunction with `cli()`.\n\t *\n\t * @example\n\t * ```js\n\t * const streamedResponse = await php.stream({\n\t * \tcode: `<?php\n\t * \t\tfor ($i = 0; $i < 5; $i++) {\n\t * \t\t\techo \"Line $i\\n\";\n\t * \t\t\tflush();\n\t * \t\t}\n\t * \t`\n\t * });\n\t *\n\t * // Process output as it becomes available\n\t * for await (const chunk of streamedResponse.text) {\n\t * \tconsole.log('Received:', chunk);\n\t * }\n\t *\n\t * // Get the final exit code\n\t * const exitCode = await streamedResponse.exitCode;\n\t * console.log('Exit code:', exitCode);\n\t * ```\n\t *\n\t * @see run() – a synchronous version of this method.\n\t * @param request - PHP runtime options.\n\t * @returns A StreamedPHPResponse object.\n\t */\n\tasync runStream(request: PHPRunOptions): Promise<StreamedPHPResponse> {\n\t\t/*\n\t\t * Prevent multiple requests from running at the same time.\n\t\t * For example, if a request is made to a PHP file that\n\t\t * requests another PHP file, the second request may\n\t\t * be dispatched before the first one is finished.\n\t\t */\n\t\tconst release = await this.semaphore.acquire();\n\t\tlet heapBodyPointer: number | undefined;\n\t\tconst streamedResponsePromise = this.#executeWithErrorHandling(() => {\n\t\t\tif (!this.#webSapiInitialized) {\n\t\t\t\tthis.#initWebRuntime();\n\t\t\t\tthis.#webSapiInitialized = true;\n\t\t\t}\n\t\t\tif (request.scriptPath && !this.fileExists(request.scriptPath)) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`The script path \"${request.scriptPath}\" does not exist.`\n\t\t\t\t);\n\t\t\t}\n\t\t\tthis.#setRelativeRequestUri(request.relativeUri || '');\n\t\t\tthis.#setRequestMethod(request.method || 'GET');\n\t\t\tconst requestHeaders = normalizeHeaders(request.headers || {});\n\t\t\tconst host = requestHeaders['host'] || 'example.com:443';\n\n\t\t\tconst port = this.#inferPortFromHostAndProtocol(\n\t\t\t\thost,\n\t\t\t\trequest.protocol || 'http'\n\t\t\t);\n\t\t\tthis.#setRequestHost(host);\n\t\t\tthis.#setRequestPort(port);\n\t\t\tthis.#setRequestHeaders(requestHeaders);\n\t\t\tif (request.body) {\n\t\t\t\theapBodyPointer = this.#setRequestBody(request.body);\n\t\t\t}\n\t\t\tif (typeof request.code === 'string') {\n\t\t\t\tthis.writeFile('/internal/eval.php', request.code);\n\t\t\t\tthis.#setScriptPath('/internal/eval.php');\n\t\t\t} else if (typeof request.scriptPath === 'string') {\n\t\t\t\tthis.#setScriptPath(request.scriptPath || '');\n\t\t\t} else {\n\t\t\t\tthrow new TypeError(\n\t\t\t\t\t'The request object must have either a `code` or a ' +\n\t\t\t\t\t\t'`scriptPath` property.'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst $_SERVER = this.#prepareServerEntries(\n\t\t\t\trequest.$_SERVER,\n\t\t\t\trequestHeaders,\n\t\t\t\tport\n\t\t\t);\n\t\t\tfor (const key in $_SERVER) {\n\t\t\t\tthis.#setServerGlobalEntry(key, $_SERVER[key]);\n\t\t\t}\n\n\t\t\tconst env = request.env || {};\n\t\t\tfor (const key in env) {\n\t\t\t\tthis.#setEnv(key, env[key]);\n\t\t\t}\n\n\t\t\tif (!this.#webSapiInitialized) {\n\t\t\t\tthis.#initWebRuntime();\n\t\t\t\tthis.#webSapiInitialized = true;\n\t\t\t}\n\n\t\t\treturn this[__private__dont__use].ccall(\n\t\t\t\t'wasm_sapi_handle_request',\n\t\t\t\tNUMBER,\n\t\t\t\t[],\n\t\t\t\t[],\n\t\t\t\t{ async: true }\n\t\t\t);\n\t\t});\n\n\t\t// Free up resources when the response is done\n\t\tawait streamedResponsePromise\n\t\t\t.catch((error) => {\n\t\t\t\tthis.dispatchEvent({\n\t\t\t\t\ttype: 'request.error',\n\t\t\t\t\terror: error as Error,\n\t\t\t\t\t// Distinguish between PHP request and PHP-wasm errors\n\t\t\t\t\tsource: (error as any).source ?? 'php-wasm',\n\t\t\t\t});\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tif (heapBodyPointer) {\n\t\t\t\t\tthis[__private__dont__use].free(heapBodyPointer);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\trelease();\n\t\t\t\tthis.dispatchEvent({\n\t\t\t\t\ttype: 'request.end',\n\t\t\t\t});\n\t\t\t});\n\t\treturn streamedResponsePromise;\n\t}\n\n\t/**\n\t * Prepares the $_SERVER entries for the PHP runtime.\n\t *\n\t * @param defaults Default entries to include in $_SERVER.\n\t * @param headers HTTP headers to include in $_SERVER (as HTTP_ prefixed entries).\n\t * @param port HTTP port, used to determine infer $_SERVER['HTTPS'] value if none\n\t *             was provided.\n\t * @returns Computed $_SERVER entries.\n\t */\n\t#prepareServerEntries(\n\t\tdefaults: Record<string, string> | undefined,\n\t\theaders: PHPRequestHeaders,\n\t\tport: number\n\t): Record<string, string> {\n\t\tconst $_SERVER = {\n\t\t\t...(defaults || {}),\n\t\t};\n\t\t$_SERVER['HTTPS'] = $_SERVER['HTTPS'] || port === 443 ? 'on' : 'off';\n\t\tfor (const name in headers) {\n\t\t\tlet HTTP_prefix = 'HTTP_';\n\t\t\t/**\n\t\t\t * Some headers are special and don't have the HTTP_ prefix.\n\t\t\t */\n\t\t\tif (\n\t\t\t\t['content-type', 'content-length'].includes(name.toLowerCase())\n\t\t\t) {\n\t\t\t\tHTTP_prefix = '';\n\t\t\t}\n\t\t\t$_SERVER[`${HTTP_prefix}${name.toUpperCase().replace(/-/g, '_')}`] =\n\t\t\t\theaders[name];\n\t\t}\n\t\treturn $_SERVER;\n\t}\n\n\t#initWebRuntime() {\n\t\tthis[__private__dont__use].ccall('php_wasm_init', null, [], []);\n\t}\n\n\t#setRelativeRequestUri(uri: string) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_request_uri',\n\t\t\tnull,\n\t\t\t[STRING],\n\t\t\t[uri]\n\t\t);\n\t\tlet queryString = '';\n\t\tif (uri.includes('?')) {\n\t\t\tqueryString = uri.substring(uri.indexOf('?') + 1);\n\t\t}\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_query_string',\n\t\t\tnull,\n\t\t\t[STRING],\n\t\t\t[queryString]\n\t\t);\n\t}\n\n\t#setRequestHost(host: string) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_request_host',\n\t\t\tnull,\n\t\t\t[STRING],\n\t\t\t[host]\n\t\t);\n\t}\n\n\t#setRequestPort(port: number) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_request_port',\n\t\t\tnull,\n\t\t\t[NUMBER],\n\t\t\t[port]\n\t\t);\n\t}\n\n\t#inferPortFromHostAndProtocol(host: string, protocol: string) {\n\t\tlet port;\n\t\ttry {\n\t\t\tport = parseInt(new URL(host).port, 10);\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\n\t\tif (!port || isNaN(port) || port === 80) {\n\t\t\tport = protocol === 'https' ? 443 : 80;\n\t\t}\n\t\treturn port;\n\t}\n\n\t#setRequestMethod(method: string) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_request_method',\n\t\t\tnull,\n\t\t\t[STRING],\n\t\t\t[method]\n\t\t);\n\t}\n\n\t#setRequestHeaders(headers: PHPRequestHeaders) {\n\t\tif (headers['cookie']) {\n\t\t\tthis[__private__dont__use].ccall(\n\t\t\t\t'wasm_set_cookies',\n\t\t\t\tnull,\n\t\t\t\t[STRING],\n\t\t\t\t[headers['cookie']]\n\t\t\t);\n\t\t}\n\t\tif (headers['content-type']) {\n\t\t\tthis[__private__dont__use].ccall(\n\t\t\t\t'wasm_set_content_type',\n\t\t\t\tnull,\n\t\t\t\t[STRING],\n\t\t\t\t[headers['content-type']]\n\t\t\t);\n\t\t}\n\t\tif (headers['content-length']) {\n\t\t\tthis[__private__dont__use].ccall(\n\t\t\t\t'wasm_set_content_length',\n\t\t\t\tnull,\n\t\t\t\t[NUMBER],\n\t\t\t\t[parseInt(headers['content-length'], 10)]\n\t\t\t);\n\t\t}\n\t}\n\n\t#setRequestBody(body: string | Uint8Array) {\n\t\tlet size, contentLength;\n\t\tif (typeof body === 'string') {\n\t\t\tlogger.warn(\n\t\t\t\t'Passing a string as the request body is deprecated. Please use a Uint8Array instead. See ' +\n\t\t\t\t\t'https://github.com/WordPress/wordpress-playground/issues/997 for more details'\n\t\t\t);\n\t\t\tcontentLength = this[__private__dont__use].lengthBytesUTF8(body);\n\t\t\tsize = contentLength + 1;\n\t\t} else {\n\t\t\tcontentLength = body.byteLength;\n\t\t\tsize = body.byteLength;\n\t\t}\n\n\t\tconst heapBodyPointer = this[__private__dont__use].malloc(size);\n\t\tif (!heapBodyPointer) {\n\t\t\tthrow new Error('Could not allocate memory for the request body.');\n\t\t}\n\n\t\t// Write the string to the WASM memory\n\t\tif (typeof body === 'string') {\n\t\t\tthis[__private__dont__use].stringToUTF8(\n\t\t\t\tbody,\n\t\t\t\theapBodyPointer,\n\t\t\t\tsize + 1\n\t\t\t);\n\t\t} else {\n\t\t\tthis[__private__dont__use].HEAPU8.set(body, heapBodyPointer);\n\t\t}\n\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_request_body',\n\t\t\tnull,\n\t\t\t[NUMBER],\n\t\t\t[heapBodyPointer]\n\t\t);\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_content_length',\n\t\t\tnull,\n\t\t\t[NUMBER],\n\t\t\t[contentLength]\n\t\t);\n\t\treturn heapBodyPointer;\n\t}\n\n\t#setScriptPath(path: string) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_path_translated',\n\t\t\tnull,\n\t\t\t[STRING],\n\t\t\t[path]\n\t\t);\n\t}\n\n\t#setServerGlobalEntry(key: string, value: string) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_add_SERVER_entry',\n\t\t\tnull,\n\t\t\t[STRING, STRING],\n\t\t\t[key, value]\n\t\t);\n\t}\n\n\t#setEnv(name: string, value: string) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_add_ENV_entry',\n\t\t\tnull,\n\t\t\t[STRING, STRING],\n\t\t\t[name, value]\n\t\t);\n\t}\n\n\t/**\n\t * Defines a constant in the PHP runtime.\n\t * @param key - The name of the constant.\n\t * @param value - The value of the constant.\n\t */\n\tdefineConstant(key: string, value: string | boolean | number | null) {\n\t\tlet consts = {};\n\t\ttry {\n\t\t\tconsts = JSON.parse(\n\t\t\t\tthis.fileExists('/internal/shared/consts.json')\n\t\t\t\t\t? this.readFileAsText('/internal/shared/consts.json') ||\n\t\t\t\t\t\t\t'{}'\n\t\t\t\t\t: '{}'\n\t\t\t);\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t\tthis.writeFile(\n\t\t\t'/internal/shared/consts.json',\n\t\t\tJSON.stringify({\n\t\t\t\t...consts,\n\t\t\t\t[key]: value,\n\t\t\t})\n\t\t);\n\t}\n\n\t/**\n\t * Executes a PHP runtime function with proper error handling and streaming setup.\n\t * Sets up streaming infrastructure and returns a StreamedPHPResponse.\n\t *\n\t * @param executionFn - Function that returns the exit code or a promise of exit code\n\t * @returns Promise that resolves to a StreamedPHPResponse\n\t */\n\tasync #executeWithErrorHandling(\n\t\texecutionFn: () => any\n\t): Promise<StreamedPHPResponse> {\n\t\tconst emscriptenModule = this[__private__dont__use];\n\n\t\tconst headers = await createInvertedReadableStream<Uint8Array>();\n\t\temscriptenModule.onHeaders = (chunk: Uint8Array) => {\n\t\t\tif (streamsClosed || headersClosed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// slice() chunk to clone the data and preserve it for the reader later on.\n\t\t\t// We need that because the ArrayBuffer underlying `chunk` may change\n\t\t\t// after this callback return. Without cloning, the reader would read\n\t\t\t// whatever bytes are available in the ArrayBuffer at the time of the read.\n\t\t\theaders.controller.enqueue(chunk.slice());\n\t\t};\n\t\tlet headersClosed = false;\n\t\tconst closeHeadersStream = () => {\n\t\t\tif (!headersClosed) {\n\t\t\t\theadersClosed = true;\n\t\t\t\theaders.controller.close();\n\t\t\t}\n\t\t};\n\n\t\tconst stdout = await createInvertedReadableStream<Uint8Array>();\n\t\temscriptenModule.onStdout = (chunk: Uint8Array) => {\n\t\t\tcloseHeadersStream();\n\t\t\tif (streamsClosed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tstdout.controller.enqueue(chunk.slice());\n\t\t};\n\n\t\tconst stderr = await createInvertedReadableStream<Uint8Array>();\n\t\temscriptenModule.onStderr = (chunk: Uint8Array) => {\n\t\t\tif (streamsClosed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tstderr.controller.enqueue(chunk.slice());\n\t\t};\n\n\t\tlet streamsClosed = false;\n\n\t\tlet errorListener: any;\n\n\t\tconst runExecutionFunction = async () => {\n\t\t\ttry {\n\t\t\t\t/*\n\t\t\t\t * Emscripten throws WASM failures outside of the promise chain so we need\n\t\t\t\t * to listen for them here and rethrow in the correct context. Otherwise we\n\t\t\t\t * get crashes and unhandled promise rejections without any useful error\n\t\t\t\t * messages or meaningful stack traces.\n\t\t\t\t */\n\t\t\t\tconst exit = await Promise.race([\n\t\t\t\t\texecutionFn(),\n\t\t\t\t\tnew Promise((_, reject) => {\n\t\t\t\t\t\terrorListener = (e: ErrorEvent) => {\n\t\t\t\t\t\t\tlogger.error(e);\n\t\t\t\t\t\t\tlogger.error(e.error);\n\t\t\t\t\t\t\tif (!isExitCode(e.error)) {\n\t\t\t\t\t\t\t\tconst rethrown = new Error('Rethrown');\n\t\t\t\t\t\t\t\trethrown.cause = e.error;\n\t\t\t\t\t\t\t\t(rethrown as any).betterMessage = e.message;\n\t\t\t\t\t\t\t\treject(rethrown);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthis.#wasmErrorsTarget?.addEventListener(\n\t\t\t\t\t\t\t'error',\n\t\t\t\t\t\t\terrorListener,\n\t\t\t\t\t\t\t{ once: true }\n\t\t\t\t\t\t);\n\t\t\t\t\t}),\n\t\t\t\t]);\n\t\t\t\treturn exit;\n\t\t\t} catch (e) {\n\t\t\t\t/**\n\t\t\t\t * Emscripten sometimes communicates program exit as an error. Let's\n\t\t\t\t * turn exit code errors into integers again.\n\t\t\t\t */\n\t\t\t\tif (isExitCode(e)) {\n\t\t\t\t\treturn e.exitCode;\n\t\t\t\t}\n\n\t\t\t\tstdout.controller.error(e);\n\t\t\t\tstderr.controller.error(e);\n\t\t\t\theaders.controller.error(e);\n\t\t\t\tstreamsClosed = true;\n\n\t\t\t\t/**\n\t\t\t\t * A non-exit-code error means an irrecoverable crash. Let's make\n\t\t\t\t * it very clear to the consumers of this API – every method\n\t\t\t\t * call on this PHP instance will throw an error from now on.\n\t\t\t\t */\n\t\t\t\tfor (const name in this) {\n\t\t\t\t\tif (typeof this[name] === 'function') {\n\t\t\t\t\t\t(this as any)[name] = () => {\n\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t`PHP runtime has crashed – see the earlier error for details.`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t(this as any).functionsMaybeMissingFromAsyncify =\n\t\t\t\t\tgetFunctionsMaybeMissingFromAsyncify();\n\n\t\t\t\tconst err = e as Error;\n\t\t\t\tconst message = (\n\t\t\t\t\t'betterMessage' in err ? err.betterMessage : err.message\n\t\t\t\t) as string;\n\n\t\t\t\tconst rethrown = new Error(message);\n\t\t\t\trethrown.cause = err;\n\t\t\t\tlogger.error(rethrown);\n\t\t\t\tthrow rethrown;\n\t\t\t} finally {\n\t\t\t\tif (!streamsClosed) {\n\t\t\t\t\tstdout.controller.close();\n\t\t\t\t\tstderr.controller.close();\n\t\t\t\t\tcloseHeadersStream();\n\t\t\t\t\tstreamsClosed = true;\n\t\t\t\t}\n\t\t\t\tthis.#wasmErrorsTarget?.removeEventListener(\n\t\t\t\t\t'error',\n\t\t\t\t\terrorListener\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\n\t\tconst exitCodePromise = runExecutionFunction();\n\n\t\treturn new StreamedPHPResponse(\n\t\t\theaders.stream,\n\t\t\tstdout.stream,\n\t\t\tstderr.stream,\n\t\t\texitCodePromise\n\t\t);\n\t}\n\n\t/**\n\t * Recursively creates a directory with the given path in the PHP filesystem.\n\t * For example, if the path is `/root/php/data`, and `/root` already exists,\n\t * it will create the directories `/root/php` and `/root/php/data`.\n\t *\n\t * @param  path - The directory path to create.\n\t */\n\tmkdir(path: string) {\n\t\treturn FSHelpers.mkdir(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * @deprecated Use mkdir instead.\n\t */\n\tmkdirTree(path: string) {\n\t\treturn FSHelpers.mkdir(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Reads a file from the PHP filesystem and returns it as a string.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param  path - The file path to read.\n\t * @returns The file contents.\n\t */\n\treadFileAsText(path: string) {\n\t\treturn FSHelpers.readFileAsText(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Reads a file from the PHP filesystem and returns it as an array buffer.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param  path - The file path to read.\n\t * @returns The file contents.\n\t */\n\treadFileAsBuffer(path: string): Uint8Array {\n\t\treturn FSHelpers.readFileAsBuffer(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Overwrites data in a file in the PHP filesystem.\n\t * Creates a new file if one doesn't exist yet.\n\t *\n\t * @param  path - The file path to write to.\n\t * @param  data - The data to write to the file.\n\t */\n\twriteFile(path: string, data: string | Uint8Array) {\n\t\treturn FSHelpers.writeFile(this[__private__dont__use].FS, path, data);\n\t}\n\n\t/**\n\t * Removes a file from the PHP filesystem.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param  path - The file path to remove.\n\t */\n\tunlink(path: string) {\n\t\treturn FSHelpers.unlink(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Moves a file or directory in the PHP filesystem to a\n\t * new location.\n\t *\n\t * @param oldPath The path to rename.\n\t * @param newPath The new path.\n\t */\n\tmv(fromPath: string, toPath: string) {\n\t\treturn FSHelpers.mv(this[__private__dont__use].FS, fromPath, toPath);\n\t}\n\n\t/**\n\t * Removes a directory from the PHP filesystem.\n\t *\n\t * @param path The directory path to remove.\n\t * @param options Options for the removal.\n\t */\n\trmdir(path: string, options: RmDirOptions = { recursive: true }) {\n\t\treturn FSHelpers.rmdir(this[__private__dont__use].FS, path, options);\n\t}\n\n\t/**\n\t * Lists the files and directories in the given directory.\n\t *\n\t * @param  path - The directory path to list.\n\t * @param  options - Options for the listing.\n\t * @returns The list of files and directories in the given directory.\n\t */\n\tlistFiles(\n\t\tpath: string,\n\t\toptions: ListFilesOptions = { prependPath: false }\n\t) {\n\t\treturn FSHelpers.listFiles(\n\t\t\tthis[__private__dont__use].FS,\n\t\t\tpath,\n\t\t\toptions\n\t\t);\n\t}\n\n\t/**\n\t * Checks if a directory exists in the PHP filesystem.\n\t *\n\t * @param  path – The path to check.\n\t * @returns True if the path is a directory, false otherwise.\n\t */\n\tisDir(path: string) {\n\t\treturn FSHelpers.isDir(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Checks if a file exists in the PHP filesystem.\n\t *\n\t * @param  path – The path to check.\n\t * @returns True if the path is a file, false otherwise.\n\t */\n\tisFile(path: string) {\n\t\treturn FSHelpers.isFile(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Creates a symlink in the PHP filesystem.\n\t * @param target\n\t * @param path\n\t */\n\tsymlink(target: string, path: string) {\n\t\treturn FSHelpers.symlink(this[__private__dont__use].FS, target, path);\n\t}\n\n\t/**\n\t * Checks if a path is a symlink in the PHP filesystem.\n\t *\n\t * @param path\n\t * @returns True if the path is a symlink, false otherwise.\n\t */\n\tisSymlink(path: string) {\n\t\treturn FSHelpers.isSymlink(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Reads the target of a symlink in the PHP filesystem.\n\t *\n\t * @param path\n\t * @returns The target of the symlink.\n\t */\n\treadlink(path: string) {\n\t\treturn FSHelpers.readlink(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Resolves the real path of a file in the PHP filesystem.\n\t * @param path\n\t * @returns The real path of the file.\n\t */\n\trealpath(path: string) {\n\t\treturn FSHelpers.realpath(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Checks if a file (or a directory) exists in the PHP filesystem.\n\t *\n\t * @param  path - The file path to check.\n\t * @returns True if the file exists, false otherwise.\n\t */\n\tfileExists(path: string) {\n\t\treturn FSHelpers.fileExists(this[__private__dont__use].FS, path);\n\t}\n\n\t/**\n\t * Hot-swaps the PHP runtime for a new one without\n\t * interrupting the operations of this PHP instance.\n\t *\n\t * @param runtime\n\t * @param cwd. Internal, the VFS path to recreate in the new runtime.\n\t *             This arg is temporary and will be removed once BasePHP\n\t *             is fully decoupled from the request handler and\n\t *             accepts a constructor-level cwd argument.\n\t */\n\tasync hotSwapPHPRuntime(runtime: number, cwd?: string) {\n\t\t// Once we secure the lock and have the new runtime ready,\n\t\t// the rest of the swap handler is synchronous to make sure\n\t\t// no other operations acts on the old runtime or FS.\n\t\t// If there was await anywhere here, we'd risk applyng\n\t\t// asynchronous changes to either the filesystem or the\n\t\t// old PHP runtime without propagating them to the new\n\t\t// runtime.\n\n\t\tconst oldFS = this[__private__dont__use].FS;\n\n\t\t// Unmount all the mount handlers\n\t\tconst mountHandlers: { mountHandler: MountHandler; vfsPath: string }[] =\n\t\t\t[];\n\t\tfor (const [vfsPath, mount] of Object.entries(this.#mounts)) {\n\t\t\tmountHandlers.push({ mountHandler: mount.mountHandler, vfsPath });\n\t\t\tawait mount.unmount();\n\t\t}\n\n\t\t// Kill the current runtime\n\t\ttry {\n\t\t\tthis.exit();\n\t\t} catch {\n\t\t\t// Ignore the exit-related exception\n\t\t}\n\n\t\t// Initialize the new runtime\n\t\tthis.initializeRuntime(runtime);\n\n\t\tif (this.#sapiName) {\n\t\t\tthis.setSapiName(this.#sapiName);\n\t\t}\n\n\t\t// Copy the old /internal directory to the new filesystem\n\t\tcopyFS(oldFS, this[__private__dont__use].FS, '/internal');\n\n\t\t// Copy the MEMFS directory structure from the old FS to the new one\n\t\tif (cwd) {\n\t\t\tcopyFS(oldFS, this[__private__dont__use].FS, cwd);\n\t\t}\n\n\t\t// Re-mount all the mount handlers\n\t\tfor (const { mountHandler, vfsPath } of mountHandlers) {\n\t\t\tthis.mkdir(vfsPath);\n\t\t\tawait this.mount(vfsPath, mountHandler);\n\t\t}\n\t}\n\n\t/**\n\t * Mounts a filesystem to a given path in the PHP filesystem.\n\t *\n\t * @param  virtualFSPath - Where to mount it in the PHP virtual filesystem.\n\t * @param  mountHandler - The mount handler to use.\n\t * @return Unmount function to unmount the filesystem.\n\t */\n\tasync mount(\n\t\tvirtualFSPath: string,\n\t\tmountHandler: MountHandler\n\t): Promise<UnmountFunction> {\n\t\tconst unmountCallback = await mountHandler(\n\t\t\tthis,\n\t\t\tthis[__private__dont__use].FS,\n\t\t\tvirtualFSPath\n\t\t);\n\t\tconst mountObject = {\n\t\t\tmountHandler,\n\t\t\tunmount: async () => {\n\t\t\t\tawait unmountCallback();\n\t\t\t\tdelete this.#mounts[virtualFSPath];\n\t\t\t},\n\t\t};\n\t\tthis.#mounts[virtualFSPath] = mountObject;\n\t\treturn () => {\n\t\t\tmountObject.unmount();\n\t\t};\n\t}\n\n\t/**\n\t * Starts a PHP CLI session with given arguments.\n\t *\n\t * This method can only be used when PHP was compiled with the CLI SAPI\n\t * and it cannot be used in conjunction with `run()`.\n\t *\n\t * Once this method finishes running, the PHP instance is no\n\t * longer usable and should be discarded. This is because PHP\n\t * internally cleans up all the resources and calls exit().\n\t *\n\t * @param  argv - The arguments to pass to the CLI.\n\t * @returns The exit code of the CLI session.\n\t */\n\tasync cli(\n\t\targv: string[],\n\t\toptions: { env?: Record<string, string> } = {}\n\t): Promise<StreamedPHPResponse> {\n\t\tconst release = await this.semaphore.acquire();\n\n\t\tconst env = options.env || {};\n\t\tfor (const [key, value] of Object.entries(env)) {\n\t\t\tthis.#setEnv(key, value);\n\t\t}\n\t\t// Enforce the use of the internal php.ini file.\n\t\targv = [argv[0], '-c', PHP_INI_PATH, ...argv.slice(1)];\n\t\tfor (const arg of argv) {\n\t\t\tthis[__private__dont__use].ccall(\n\t\t\t\t'wasm_add_cli_arg',\n\t\t\t\tnull,\n\t\t\t\t[STRING],\n\t\t\t\t[arg]\n\t\t\t);\n\t\t}\n\n\t\treturn await this.#executeWithErrorHandling(() => {\n\t\t\treturn this[__private__dont__use].ccall('run_cli', null, [], [], {\n\t\t\t\tasync: true,\n\t\t\t});\n\t\t}).then((response) => {\n\t\t\tresponse.exitCode.finally(release);\n\t\t\treturn response;\n\t\t});\n\t}\n\n\tsetSkipShebang(shouldSkip: boolean) {\n\t\tthis[__private__dont__use].ccall(\n\t\t\t'wasm_set_skip_shebang',\n\t\t\tnull,\n\t\t\t[NUMBER],\n\t\t\t[shouldSkip ? 1 : 0]\n\t\t);\n\t}\n\n\texit(code = 0) {\n\t\tthis.dispatchEvent({\n\t\t\ttype: 'runtime.beforedestroy',\n\t\t});\n\t\ttry {\n\t\t\tthis[__private__dont__use]._exit(code);\n\t\t} catch {\n\t\t\t// ignore the exit error\n\t\t}\n\n\t\t// Clean up any initialized state\n\t\tthis.#webSapiInitialized = false;\n\n\t\t// Delete any links between this PHP instance and the runtime\n\t\tthis.#wasmErrorsTarget = null;\n\n\t\tif (this[__private__dont__use]) {\n\t\t\tdelete this[__private__dont__use]['onMessage'];\n\t\t\tdelete this[__private__dont__use];\n\t\t}\n\t}\n\n\t[Symbol.dispose]() {\n\t\tif (this.#webSapiInitialized) {\n\t\t\tthis.exit(0);\n\t\t}\n\t}\n}\n\nexport function normalizeHeaders(\n\theaders: PHPRequestHeaders\n): PHPRequestHeaders {\n\tconst normalized: PHPRequestHeaders = {};\n\tfor (const key in headers) {\n\t\tnormalized[key.toLowerCase()] = headers[key];\n\t}\n\treturn normalized;\n}\n\n/**\n * Copies the MEMFS directory structure from one FS in another FS.\n * Non-MEMFS nodes are ignored.\n */\nfunction copyFS(\n\tsource: Emscripten.FileSystemInstance,\n\ttarget: Emscripten.FileSystemInstance,\n\tpath: string\n) {\n\tlet oldNode;\n\ttry {\n\t\toldNode = source.lookupPath(path);\n\t} catch {\n\t\treturn;\n\t}\n\t// MEMFS nodes have a `contents` property. NODEFS nodes don't.\n\t// We only want to copy MEMFS nodes here.\n\tif (!('contents' in oldNode.node)) {\n\t\treturn;\n\t}\n\n\t// Let's be extra careful and only proceed if newFs doesn't\n\t// already have a node at the given path.\n\ttry {\n\t\t// @TODO: Figure out the right thing to do. In Parent -> child PHP case,\n\t\t//        we indeed want to synchronize the entire filesystem. However,\n\t\t//        this approach seems slow and inefficient. Instead of exhaustively\n\t\t//        iterating, could we just mark directories as dirty on write? And\n\t\t//        how do we sync in both directions?\n\t\t// target = target.lookupPath(path);\n\t\t// return;\n\t} catch {\n\t\t// There's no such node in the new FS. Good,\n\t\t// we may proceed.\n\t}\n\n\tif (!source.isDir(oldNode.node.mode)) {\n\t\ttarget.writeFile(path, source.readFile(path));\n\t\treturn;\n\t}\n\n\ttarget.mkdirTree(path);\n\tconst filenames = source\n\t\t.readdir(path)\n\t\t.filter((name: string) => name !== '.' && name !== '..');\n\tfor (const filename of filenames) {\n\t\tcopyFS(source, target, joinPaths(path, filename));\n\t}\n}\nasync function createInvertedReadableStream<T = BufferSource>(\n\tsource: UnderlyingSource<T> = {}\n) {\n\tlet controllerResolve: (\n\t\tcontroller: ReadableStreamDefaultController<T>\n\t) => void;\n\tconst controllerPromise = new Promise<ReadableStreamDefaultController<T>>(\n\t\t(resolve) => {\n\t\t\tcontrollerResolve = resolve;\n\t\t}\n\t);\n\n\tconst stream = new ReadableStream<T>({\n\t\t...source,\n\t\tstart(controller) {\n\t\t\t// Type assertion to handle the controller type mismatch\n\t\t\tcontrollerResolve(controller as ReadableStreamDefaultController<T>);\n\t\t\tif (source.start) {\n\t\t\t\treturn source.start(controller);\n\t\t\t}\n\t\t\treturn undefined;\n\t\t},\n\t});\n\n\tconst controller = await controllerPromise;\n\n\treturn {\n\t\tstream,\n\t\tcontroller,\n\t};\n}\n","import { PHP_INI_PATH } from './php';\nimport type { UniversalPHP } from './universal-php';\nimport { stringify, parse } from 'ini';\n\n/**\n * Reads the php.ini file and returns its entries.\n *\n * @param php The PHP instance.\n * @param entries Optional. If provided, only the specified entries will be returned.\n * @returns The php.ini entries.\n */\nexport async function getPhpIniEntries(php: UniversalPHP, entries?: string[]) {\n\tconst ini = parse(await php.readFileAsText(PHP_INI_PATH));\n\tif (entries === undefined) {\n\t\treturn ini;\n\t}\n\tconst result: Record<string, unknown> = {};\n\tfor (const key of entries) {\n\t\tresult[key] = ini[key];\n\t}\n\treturn result;\n}\n\n/**\n * Rewrites the php.ini file with the given entries.\n *\n * @param php The PHP instance.\n * @param entries The entries to write to the php.ini file.\n */\nexport async function setPhpIniEntries(\n\tphp: UniversalPHP,\n\tentries: Record<string, unknown>\n) {\n\tconst ini = parse(await php.readFileAsText(PHP_INI_PATH));\n\tfor (const [key, value] of Object.entries(entries)) {\n\t\tif (value === undefined || value === null) {\n\t\t\tdelete ini[key];\n\t\t} else {\n\t\t\tini[key] = value;\n\t\t}\n\t}\n\tawait php.writeFile(PHP_INI_PATH, stringify(ini));\n}\n\n/**\n * Sets php.ini values to the given values, executes a callback,\n * and restores the original php.ini values. This is useful for\n * running code with temporary php.ini values, such as when\n * disabling network-related PHP functions just to run WordPress\n * installer.\n *\n * @example\n * ```ts\n *\tawait withPHPIniValues(\n *\t\tphp,\n *\t\t{\n *\t\t\tdisable_functions: 'fsockopen',\n *\t\t\tallow_url_fopen: '0',\n *\t\t},\n *\t\tasync () => await runWpInstallationWizard(php, {\n *\t\t\toptions: {},\n *\t\t})\n *\t);\n *\t```\n *\n * @param php The PHP instance.\n * @param phpIniValues The php.ini values to set.\n * @param callback The callback to execute.\n * @returns The result of the callback.\n */\nexport async function withPHPIniValues(\n\tphp: UniversalPHP,\n\tphpIniValues: Record<string, string>,\n\tcallback: () => Promise<any>\n) {\n\tconst iniBefore = await php.readFileAsText(PHP_INI_PATH);\n\ttry {\n\t\tawait setPhpIniEntries(php, phpIniValues);\n\t\treturn await callback();\n\t} finally {\n\t\tawait php.writeFile(PHP_INI_PATH, iniBefore);\n\t}\n}\n","import { logger } from '@php-wasm/logger';\nimport type { CookieStore } from './php-request-handler';\n/**\n * @public\n */\nexport class HttpCookieStore implements CookieStore {\n\tcookies: Record<string, string> = {};\n\n\trememberCookiesFromResponseHeaders(headers: Record<string, string[]>) {\n\t\tif (!headers?.['set-cookie']) {\n\t\t\treturn;\n\t\t}\n\t\tfor (const setCookie of headers['set-cookie']) {\n\t\t\ttry {\n\t\t\t\tif (!setCookie.includes('=')) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst equalsIndex = setCookie.indexOf('=');\n\t\t\t\tconst name = setCookie.substring(0, equalsIndex);\n\t\t\t\tconst value = setCookie\n\t\t\t\t\t.substring(equalsIndex + 1)\n\t\t\t\t\t.split(';')[0];\n\t\t\t\tthis.cookies[name] = value;\n\t\t\t} catch (e) {\n\t\t\t\tlogger.error(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tgetCookieRequestHeader() {\n\t\tconst cookiesArray: string[] = [];\n\t\tfor (const name in this.cookies) {\n\t\t\tcookiesArray.push(`${name}=${this.cookies[name]}`);\n\t\t}\n\t\treturn cookiesArray.join('; ');\n\t}\n}\n","import type { UniversalPHP } from './universal-php';\n\n/**\n * Reads a file from PHP filesystem using a stream.\n */\nexport function streamReadFileFromPHP(php: UniversalPHP, path: string) {\n\treturn new ReadableStream({\n\t\tasync pull(controller) {\n\t\t\tconst buffer = await php.readFileAsBuffer(path);\n\t\t\tcontroller.enqueue(buffer);\n\t\t\tcontroller.close();\n\t\t},\n\t});\n}\n","import { joinPaths, normalizePath } from '@php-wasm/util';\nimport { StreamedFile } from '@php-wasm/stream-compression';\nimport type { UniversalPHP } from './universal-php';\nimport { streamReadFileFromPHP } from './stream-read-file-from-php';\n\nexport type IteratePhpFilesOptions = {\n\t/**\n\t * Should yield paths relative to the root directory?\n\t * If false, all paths will be absolute.\n\t */\n\trelativePaths?: boolean;\n\n\t/**\n\t * A prefix to add to all paths.\n\t * Only used if `relativePaths` is true.\n\t */\n\tpathPrefix?: string;\n\n\t/**\n\t * A list of paths to exclude from the results.\n\t */\n\texceptPaths?: string[];\n};\n\n/**\n * Iterates over all files in a php directory and its subdirectories.\n *\n * @param php - The PHP instance.\n * @param root - The root directory to start iterating from.\n * @param options - Optional configuration.\n * @returns All files found in the tree.\n */\nexport async function* iteratePhpFiles(\n\tphp: UniversalPHP,\n\troot: string,\n\t{\n\t\trelativePaths = true,\n\t\tpathPrefix,\n\t\texceptPaths = [],\n\t}: IteratePhpFilesOptions = {}\n): AsyncGenerator<File> {\n\troot = normalizePath(root);\n\tconst stack: string[] = [root];\n\twhile (stack.length) {\n\t\tconst currentParent = stack.pop();\n\t\tif (!currentParent) {\n\t\t\treturn;\n\t\t}\n\t\tconst files = await php.listFiles(currentParent);\n\t\tfor (const file of files) {\n\t\t\tconst absPath = `${currentParent}/${file}`;\n\t\t\tif (exceptPaths.includes(absPath.substring(root.length + 1))) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst isDir = await php.isDir(absPath);\n\t\t\tif (isDir) {\n\t\t\t\tstack.push(absPath);\n\t\t\t} else {\n\t\t\t\tyield new StreamedFile(\n\t\t\t\t\tstreamReadFileFromPHP(php, absPath),\n\t\t\t\t\trelativePaths\n\t\t\t\t\t\t? joinPaths(\n\t\t\t\t\t\t\t\tpathPrefix || '',\n\t\t\t\t\t\t\t\tabsPath.substring(root.length + 1)\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t: absPath\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n}\n","import { dirname, joinPaths } from '@php-wasm/util';\nimport type { UniversalPHP } from './universal-php';\n\n/**\n * Writes streamed files to PHP filesystem.\n */\nexport function writeFilesStreamToPhp(php: UniversalPHP, root: string) {\n\treturn new WritableStream({\n\t\tasync write(file: File) {\n\t\t\tconst filePath = joinPaths(root, file.name);\n\t\t\tif (file.type === 'directory') {\n\t\t\t\tawait php.mkdir(filePath);\n\t\t\t} else {\n\t\t\t\tawait php.mkdir(dirname(filePath));\n\t\t\t\tawait php.writeFile(\n\t\t\t\t\tfilePath,\n\t\t\t\t\tnew Uint8Array(await file.arrayBuffer())\n\t\t\t\t);\n\t\t\t}\n\t\t},\n\t});\n}\n","import { AcquireTimeoutError, Semaphore } from '@php-wasm/util';\nimport type { PHP } from './php';\n\nexport type PHPFactoryOptions = {\n\tisPrimary: boolean;\n};\n\nexport type PHPFactory = (options: PHPFactoryOptions) => Promise<PHP>;\n\nexport interface ProcessManagerOptions {\n\t/**\n\t * The maximum number of PHP instances that can exist at\n\t * the same time.\n\t */\n\tmaxPhpInstances?: number;\n\t/**\n\t * The number of milliseconds to wait for a PHP instance when\n\t * we have reached the maximum number of PHP instances and\n\t * cannot spawn a new one. If the timeout is reached, we assume\n\t * all the PHP instances are deadlocked and a throw MaxPhpInstancesError.\n\t *\n\t * Default: 5000\n\t */\n\ttimeout?: number;\n\t/**\n\t * The primary PHP instance that's never killed. This instance\n\t * contains the reference filesystem used by all other PHP instances.\n\t */\n\tprimaryPhp?: PHP;\n\t/**\n\t * A factory function used for spawning new PHP instances.\n\t */\n\tphpFactory?: PHPFactory;\n}\n\nexport interface SpawnedPHP {\n\tphp: PHP;\n\treap: () => void;\n}\n\nexport class MaxPhpInstancesError extends Error {\n\tconstructor(limit: number) {\n\t\tsuper(\n\t\t\t`Requested more concurrent PHP instances than the limit (${limit}).`\n\t\t);\n\t\tthis.name = this.constructor.name;\n\t}\n}\n\n/**\n * A PHP Process manager.\n *\n * Maintains:\n * * A single \"primary\" PHP instance that's never killed – it contains the\n *   reference filesystem used by all other PHP instances.\n * * A pool of disposable PHP instances that are spawned to handle a single\n *   request and reaped immediately after.\n *\n * When a new request comes in, PHPProcessManager yields the idle instance to\n * handle it, and immediately starts initializing a new idle instance. In other\n * words, for n concurrent requests, there are at most n+1 PHP instances\n * running at the same time.\n *\n * A slight nuance is that the first idle instance is not initialized until the\n * first concurrent request comes in. This is because many use-cases won't\n * involve parallel requests and, for those, we can avoid eagerly spinning up a\n * second PHP instance.\n *\n * This strategy is inspired by Cowboy, an Erlang HTTP server. Handling a\n * single extra request can happen immediately, while handling multiple extra\n * requests requires extra time to spin up a few PHP instances. This is a more\n * resource-friendly tradeoff than keeping 5 idle instances at all times.\n */\nexport class PHPProcessManager implements AsyncDisposable {\n\tprivate primaryPhp?: PHP;\n\tprivate primaryPhpPromise?: Promise<SpawnedPHP>;\n\tprivate primaryIdle = true;\n\tprivate nextInstance: Promise<SpawnedPHP> | null = null;\n\t/**\n\t * All spawned PHP instances, including the primary PHP instance.\n\t * Used for bookkeeping and reaping all instances on dispose.\n\t */\n\tprivate allInstances: Promise<SpawnedPHP>[] = [];\n\tprivate phpFactory?: PHPFactory;\n\tprivate maxPhpInstances: number;\n\tprivate semaphore: Semaphore;\n\n\tconstructor(options?: ProcessManagerOptions) {\n\t\tthis.maxPhpInstances = options?.maxPhpInstances ?? 5;\n\t\tthis.phpFactory = options?.phpFactory;\n\t\tthis.primaryPhp = options?.primaryPhp;\n\t\tthis.semaphore = new Semaphore({\n\t\t\tconcurrency: this.maxPhpInstances,\n\t\t\t/**\n\t\t\t * Wait up to 5 seconds for resources to become available\n\t\t\t * before assuming that all the PHP instances are deadlocked.\n\t\t\t */\n\t\t\ttimeout: options?.timeout || 5000,\n\t\t});\n\t}\n\n\t/**\n\t * Get the primary PHP instance.\n\t *\n\t * If the primary PHP instance is not set, it will be spawned\n\t * using the provided phpFactory.\n\t *\n\t * @throws {Error} when called twice before the first call is resolved.\n\t */\n\tasync getPrimaryPhp() {\n\t\tif (!this.phpFactory && !this.primaryPhp) {\n\t\t\tthrow new Error(\n\t\t\t\t'phpFactory or primaryPhp must be set before calling getPrimaryPhp().'\n\t\t\t);\n\t\t} else if (!this.primaryPhp) {\n\t\t\tif (!this.primaryPhpPromise) {\n\t\t\t\tthis.primaryPhpPromise = this.spawn({ isPrimary: true });\n\t\t\t}\n\t\t\tthis.primaryPhp = (await this.primaryPhpPromise).php;\n\t\t\tthis.primaryPhpPromise = undefined;\n\t\t}\n\t\treturn this.primaryPhp!;\n\t}\n\n\t/**\n\t * Get a PHP instance.\n\t *\n\t * It could be either the primary PHP instance, an idle disposable PHP\n\t * instance, or a newly spawned PHP instance – depending on the resource\n\t * availability.\n\t *\n\t * @param considerPrimary - Whether to consider the primary PHP instance.\n\t *                          It matters because PHP.cli() sets the SAPI to CLI and\n\t *                          kills the entire process after it finishes running,\n\t *                          making the primary PHP instance non-reusable for\n\t *                          subsequent .run() calls. This is fine for one-off\n\t *                          child PHP instances, but not for the primary PHP\n\t *                          that's meant to continue working for the entire duration\n\t *                          of the ProcessManager lifetime. Therefore, we don't\n\t *                          consider the primary PHP instance by default unless\n\t *                          the caller explicitly requests it.\n\t *\n\t * @throws {MaxPhpInstancesError} when the maximum number of PHP instances is reached\n\t *                                and the waiting timeout is exceeded.\n\t */\n\tasync acquirePHPInstance({\n\t\tconsiderPrimary = true,\n\t}: {\n\t\tconsiderPrimary?: boolean;\n\t} = {}): Promise<SpawnedPHP> {\n\t\t/**\n\t\t * First and foremost, make sure we have the primary PHP instance in place.\n\t\t * We don't acquire it yet. We just make sure it exists.\n\t\t *\n\t\t * @TODO: Decouple Filesystem from PHP to get rid of the notion of a primary PHP instance.\n\t\t * @see https://github.com/WordPress/wordpress-playground/issues/2269\n\t\t */\n\t\tif (!this.primaryPhp) {\n\t\t\tawait this.getPrimaryPhp();\n\t\t}\n\n\t\tif (this.primaryIdle && considerPrimary) {\n\t\t\tthis.primaryIdle = false;\n\t\t\treturn {\n\t\t\t\tphp: await this.getPrimaryPhp(),\n\t\t\t\treap: () => {\n\t\t\t\t\tthis.primaryIdle = true;\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t/**\n\t\t * nextInstance is null:\n\t\t *\n\t\t * * Before the first concurrent getInstance() call\n\t\t * * When the last getInstance() call did not have enough\n\t\t *   budget left to optimistically start spawning the next\n\t\t *   instance.\n\t\t */\n\t\tconst spawnedPhp =\n\t\t\tthis.nextInstance || this.spawn({ isPrimary: false });\n\n\t\t/**\n\t\t * Start spawning the next instance if there's still room. We can't\n\t\t * just always spawn the next instance because spawn() can fail\n\t\t * asynchronously and then we'll get an unhandled promise rejection.\n\t\t */\n\t\tif (this.semaphore.remaining > 0) {\n\t\t\tthis.nextInstance = this.spawn({ isPrimary: false });\n\t\t} else {\n\t\t\tthis.nextInstance = null;\n\t\t}\n\t\treturn await spawnedPhp;\n\t}\n\n\t/**\n\t * Initiated spawning of a new PHP instance.\n\t * This function is synchronous on purpose – it needs to synchronously\n\t * add the spawn promise to the allInstances array without waiting\n\t * for PHP to spawn.\n\t */\n\tprivate spawn(factoryArgs: PHPFactoryOptions): Promise<SpawnedPHP> {\n\t\tif (factoryArgs.isPrimary) {\n\t\t\tif (this.primaryPhpPromise && !this.primaryPhp) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Requested spawning a primary PHP instance when another primary instance already started spawning.'\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\tconst spawned = this.doSpawn(factoryArgs);\n\t\tthis.allInstances.push(spawned);\n\t\tconst pop = () => {\n\t\t\tthis.allInstances = this.allInstances.filter(\n\t\t\t\t(instance) => instance !== spawned\n\t\t\t);\n\t\t};\n\t\treturn spawned\n\t\t\t.catch((rejection) => {\n\t\t\t\tpop();\n\t\t\t\tthrow rejection;\n\t\t\t})\n\t\t\t.then((result) => ({\n\t\t\t\t...result,\n\t\t\t\treap: () => {\n\t\t\t\t\tpop();\n\t\t\t\t\tresult.reap();\n\t\t\t\t},\n\t\t\t}));\n\t}\n\n\t/**\n\t * Actually acquires the lock and spawns a new PHP instance.\n\t */\n\tprivate async doSpawn(factoryArgs: PHPFactoryOptions): Promise<SpawnedPHP> {\n\t\tlet release: () => void;\n\t\ttry {\n\t\t\trelease = await this.semaphore.acquire();\n\t\t} catch (error) {\n\t\t\tif (error instanceof AcquireTimeoutError) {\n\t\t\t\tthrow new MaxPhpInstancesError(this.maxPhpInstances);\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t\ttry {\n\t\t\tconst php = await this.phpFactory!(factoryArgs);\n\t\t\treturn {\n\t\t\t\tphp,\n\t\t\t\treap() {\n\t\t\t\t\tphp.exit();\n\t\t\t\t\trelease();\n\t\t\t\t},\n\t\t\t};\n\t\t} catch (e) {\n\t\t\trelease();\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tasync [Symbol.asyncDispose]() {\n\t\tif (this.primaryPhp) {\n\t\t\tthis.primaryPhp.exit();\n\t\t}\n\t\tawait Promise.all(\n\t\t\tthis.allInstances.map((instance) =>\n\t\t\t\tinstance.then(({ reap }) => reap())\n\t\t\t)\n\t\t);\n\t}\n}\n","export const SupportedPHPVersions = [\n\t'8.4',\n\t'8.3',\n\t'8.2',\n\t'8.1',\n\t'8.0',\n\t'7.4',\n\t'7.3',\n\t'7.2',\n] as const;\nexport const LatestSupportedPHPVersion = SupportedPHPVersions[0];\nexport const SupportedPHPVersionsList = SupportedPHPVersions as any as string[];\nexport type SupportedPHPVersion = (typeof SupportedPHPVersions)[number];\n","/**\n * The default base used to convert a path into the URL object.\n */\nexport const DEFAULT_BASE_URL = 'http://example.com';\n\n/**\n * Returns a string representing the path, query, and\n * fragment of the given URL.\n *\n * @example\n * ```js\n * const url = new URL('http://example.com/foo/bar?baz=qux#quux');\n * toRelativeUrl(url); // '/foo/bar?baz=qux#quux'\n * ```\n *\n * @param  url The URL.\n * @returns The path, query, and fragment.\n */\nexport function toRelativeUrl(url: URL): string {\n\treturn url.toString().substring(url.origin.length);\n}\n\n/**\n * Removes the given prefix from the given path.\n *\n * @example\n * ```js\n * removePathPrefix('/foo/bar', '/foo'); // '/bar'\n * removePathPrefix('/bar', '/foo'); // '/bar'\n * ```\n *\n * @param  path   The path to remove the prefix from.\n * @param  prefix The prefix to remove.\n * @returns Path with the prefix removed.\n */\nexport function removePathPrefix(path: string, prefix: string): string {\n\tif (!prefix || !path.startsWith(prefix)) {\n\t\treturn path;\n\t}\n\treturn path.substring(prefix.length);\n}\n\n/**\n * Ensures the given path has the given prefix.\n *\n * @example\n * ```js\n * ensurePathPrefix('/bar', '/foo'); // '/foo/bar'\n * ensurePathPrefix('/foo/bar', '/foo'); // '/foo/bar'\n * ```\n *\n * @param  path\n * @param  prefix\n * @returns Path with the prefix added.\n */\nexport function ensurePathPrefix(path: string, prefix: string): string {\n\tif (!prefix || path.startsWith(prefix)) {\n\t\treturn path;\n\t}\n\treturn prefix + path;\n}\n","/**\n * Encodes a multipart/form-data request body.\n *\n * @param   data - The form data to encode.\n * @returns The encoded body and a correctly formatted content type header.\n */\nexport async function encodeAsMultipart(\n\tdata: Record<string, string | Uint8Array | File>\n) {\n\tconst boundary = `----${Math.random().toString(36).slice(2)}`;\n\tconst contentType = `multipart/form-data; boundary=${boundary}`;\n\n\tconst textEncoder = new TextEncoder();\n\tconst parts: (string | Uint8Array)[] = [];\n\tfor (const [name, value] of Object.entries(data)) {\n\t\tparts.push(`--${boundary}\\r\\n`);\n\t\tparts.push(`Content-Disposition: form-data; name=\"${name}\"`);\n\t\tif (value instanceof File) {\n\t\t\tparts.push(`; filename=\"${value.name}\"`);\n\t\t}\n\t\tparts.push(`\\r\\n`);\n\t\tif (value instanceof File) {\n\t\t\tparts.push(`Content-Type: application/octet-stream`);\n\t\t\tparts.push(`\\r\\n`);\n\t\t}\n\t\tparts.push(`\\r\\n`);\n\t\tif (value instanceof File) {\n\t\t\tparts.push(await fileToUint8Array(value));\n\t\t} else {\n\t\t\tparts.push(value);\n\t\t}\n\t\tparts.push(`\\r\\n`);\n\t}\n\tparts.push(`--${boundary}--\\r\\n`);\n\n\tconst length = parts.reduce((acc, part) => acc + part.length, 0);\n\tconst bytes = new Uint8Array(length);\n\tlet offset = 0;\n\tfor (const part of parts) {\n\t\tbytes.set(\n\t\t\ttypeof part === 'string' ? textEncoder.encode(part) : part,\n\t\t\toffset\n\t\t);\n\t\toffset += part.length;\n\t}\n\treturn { bytes, contentType };\n}\n\nfunction fileToUint8Array(file: File): Promise<Uint8Array> {\n\t/**\n\t * @mbuella: Use File.arrayBuffer() to get a Uint8Array from a file, avoiding FileReader\n\t * which is browser-specific. This method is supported in major browsers and NodeJS/Deno runtimes.\n\t */\n\treturn file.arrayBuffer().then((fileBuffer) => new Uint8Array(fileBuffer));\n}\n","import { joinPaths } from '@php-wasm/util';\nimport {\n\tensurePathPrefix,\n\ttoRelativeUrl,\n\tremovePathPrefix,\n\tDEFAULT_BASE_URL,\n} from './urls';\nimport type { PHP, PHPExecutionFailureError } from './php';\nimport { normalizeHeaders } from './php';\nimport { PHPResponse } from './php-response';\nimport type { PHPRequest, PHPRunOptions } from './universal-php';\nimport { encodeAsMultipart } from './encode-as-multipart';\nimport type { PHPFactoryOptions, SpawnedPHP } from './php-process-manager';\nimport { MaxPhpInstancesError, PHPProcessManager } from './php-process-manager';\nimport { HttpCookieStore } from './http-cookie-store';\nimport mimeTypes from './mime-types.json';\n\nexport type RewriteRule = {\n\tmatch: RegExp;\n\treplacement: string;\n};\n\nexport type FileNotFoundToResponse = {\n\ttype: 'response';\n\tresponse: PHPResponse;\n};\nexport type FileNotFoundToInternalRedirect = {\n\ttype: 'internal-redirect';\n\turi: string;\n};\nexport type FileNotFoundTo404 = { type: '404' };\n\nexport type FileNotFoundAction =\n\t| FileNotFoundToResponse\n\t| FileNotFoundToInternalRedirect\n\t| FileNotFoundTo404;\n\nexport type FileNotFoundGetActionCallback = (\n\trelativePath: string\n) => FileNotFoundAction;\n\n/**\n * Interface for cookie storage implementations.\n * This allows different cookie handling strategies to be used with the PHP request handler.\n */\nexport interface CookieStore {\n\t/**\n\t * Processes and stores cookies from response headers\n\t * @param headers Response headers containing Set-Cookie directives\n\t */\n\trememberCookiesFromResponseHeaders(headers: Record<string, string[]>): void;\n\n\t/**\n\t * Gets the cookie header string for the next request\n\t * @returns Formatted cookie header string\n\t */\n\tgetCookieRequestHeader(): string;\n}\n\ninterface BaseConfiguration {\n\t/**\n\t * The directory in the PHP filesystem where the server will look\n\t * for the files to serve. Default: `/var/www`.\n\t */\n\tdocumentRoot?: string;\n\t/**\n\t * Request Handler URL. Used to populate $_SERVER details like HTTP_HOST.\n\t */\n\tabsoluteUrl?: string;\n\n\t/**\n\t * Rewrite rules\n\t */\n\trewriteRules?: RewriteRule[];\n\n\t/**\n\t * A callback that decides how to handle a file-not-found condition for a\n\t * given request URI.\n\t */\n\tgetFileNotFoundAction?: FileNotFoundGetActionCallback;\n}\n\nexport type PHPRequestHandlerFactoryArgs = PHPFactoryOptions & {\n\trequestHandler: PHPRequestHandler;\n};\n\nexport type PHPRequestHandlerConfiguration = BaseConfiguration &\n\t(\n\t\t| {\n\t\t\t\t/**\n\t\t\t\t * PHPProcessManager is required because the request handler needs\n\t\t\t\t * to make a decision for each request.\n\t\t\t\t *\n\t\t\t\t * Static assets are served using the primary PHP's filesystem, even\n\t\t\t\t * when serving 100 static files concurrently. No new PHP interpreter\n\t\t\t\t * is ever created as there's no need for it.\n\t\t\t\t *\n\t\t\t\t * Dynamic PHP requests, however, require grabbing an available PHP\n\t\t\t\t * interpreter, and that's where the PHPProcessManager comes in.\n\t\t\t\t */\n\t\t\t\tprocessManager: PHPProcessManager;\n\t\t  }\n\t\t| {\n\t\t\t\tphpFactory: (\n\t\t\t\t\trequestHandler: PHPRequestHandlerFactoryArgs\n\t\t\t\t) => Promise<PHP>;\n\t\t\t\t/**\n\t\t\t\t * The maximum number of PHP instances that can exist at\n\t\t\t\t * the same time.\n\t\t\t\t */\n\t\t\t\tmaxPhpInstances?: number;\n\t\t  }\n\t) & {\n\t\tcookieStore?: CookieStore | false;\n\t};\n\n/**\n * Handles HTTP requests using PHP runtime as a backend.\n *\n * @public\n * @example Use PHPRequestHandler implicitly with a new PHP instance:\n * ```js\n * import { PHP } from '@php-wasm/web';\n *\n * const php = await PHP.load( '7.4', {\n *     requestHandler: {\n *         // PHP FS path to serve the files from:\n *         documentRoot: '/www',\n *\n *         // Used to populate $_SERVER['SERVER_NAME'] etc.:\n *         absoluteUrl: 'http://127.0.0.1'\n *     }\n * } );\n *\n * php.mkdirTree('/www');\n * php.writeFile('/www/index.php', '<?php echo \"Hi from PHP!\"; ');\n *\n * const response = await php.request({ path: '/index.php' });\n * console.log(response.text);\n * // \"Hi from PHP!\"\n * ```\n *\n * @example Explicitly create a PHPRequestHandler instance and run a PHP script:\n * ```js\n * import {\n *   loadPHPRuntime,\n *   PHP,\n *   PHPRequestHandler,\n *   getPHPLoaderModule,\n * } from '@php-wasm/web';\n *\n * const runtime = await loadPHPRuntime( await getPHPLoaderModule('7.4') );\n * const php = new PHP( runtime );\n *\n * php.mkdirTree('/www');\n * php.writeFile('/www/index.php', '<?php echo \"Hi from PHP!\"; ');\n *\n * const server = new PHPRequestHandler(php, {\n *     // PHP FS path to serve the files from:\n *     documentRoot: '/www',\n *\n *     // Used to populate $_SERVER['SERVER_NAME'] etc.:\n *     absoluteUrl: 'http://127.0.0.1'\n * });\n *\n * const response = server.request({ path: '/index.php' });\n * console.log(response.text);\n * // \"Hi from PHP!\"\n * ```\n */\nexport class PHPRequestHandler implements AsyncDisposable {\n\t#DOCROOT: string;\n\t#PROTOCOL: string;\n\t#HOSTNAME: string;\n\t#PORT: number;\n\t#HOST: string;\n\t#PATHNAME: string;\n\t#ABSOLUTE_URL: string;\n\t#cookieStore: CookieStore | false;\n\trewriteRules: RewriteRule[];\n\tprocessManager: PHPProcessManager;\n\tgetFileNotFoundAction: FileNotFoundGetActionCallback;\n\n\t/**\n\t * The request handler needs to decide whether to serve a static asset or\n\t * run the PHP interpreter. For static assets it should just reuse the primary\n\t * PHP even if there's 50 concurrent requests to serve. However, for\n\t * dynamic PHP requests, it needs to grab an available interpreter.\n\t * Therefore, it cannot just accept PHP as an argument as serving requests\n\t * requires access to ProcessManager.\n\t *\n\t * @param  php    - The PHP instance.\n\t * @param  config - Request Handler configuration.\n\t */\n\tconstructor(config: PHPRequestHandlerConfiguration) {\n\t\tconst {\n\t\t\tdocumentRoot = '/www/',\n\t\t\tabsoluteUrl = typeof location === 'object'\n\t\t\t\t? location.href\n\t\t\t\t: DEFAULT_BASE_URL,\n\t\t\trewriteRules = [],\n\t\t\tgetFileNotFoundAction = () => ({ type: '404' }),\n\t\t} = config;\n\n\t\tif ('processManager' in config) {\n\t\t\tthis.processManager = config.processManager;\n\t\t} else {\n\t\t\tthis.processManager = new PHPProcessManager({\n\t\t\t\tphpFactory: async (info) => {\n\t\t\t\t\tconst php = await config.phpFactory!({\n\t\t\t\t\t\t...info,\n\t\t\t\t\t\trequestHandler: this,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Always set managed PHP's cwd to the document root.\n\t\t\t\t\tif (!php.isDir(documentRoot)) {\n\t\t\t\t\t\tphp.mkdir(documentRoot);\n\t\t\t\t\t}\n\t\t\t\t\tphp.chdir(documentRoot);\n\n\t\t\t\t\t// @TODO: Decouple PHP and request handler\n\t\t\t\t\t(php as any).requestHandler = this;\n\t\t\t\t\treturn php;\n\t\t\t\t},\n\t\t\t\tmaxPhpInstances: config.maxPhpInstances,\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * By default, config.cookieStore is undefined, so we use the\n\t\t * HttpCookieStore implementation, otherwise we use the one\n\t\t * provided in the config.\n\t\t *\n\t\t * By explicitly checking for `undefined` we allow the user to pass\n\t\t * `null` as config.cookieStore and disable the cookie store.\n\t\t */\n\t\tthis.#cookieStore =\n\t\t\tconfig.cookieStore === undefined\n\t\t\t\t? new HttpCookieStore()\n\t\t\t\t: config.cookieStore;\n\t\tthis.#DOCROOT = documentRoot;\n\n\t\tconst url = new URL(absoluteUrl);\n\t\tthis.#HOSTNAME = url.hostname;\n\t\tthis.#PORT = url.port\n\t\t\t? Number(url.port)\n\t\t\t: url.protocol === 'https:'\n\t\t\t? 443\n\t\t\t: 80;\n\t\tthis.#PROTOCOL = (url.protocol || '').replace(':', '');\n\t\tconst isNonStandardPort = this.#PORT !== 443 && this.#PORT !== 80;\n\t\tthis.#HOST = [\n\t\t\tthis.#HOSTNAME,\n\t\t\tisNonStandardPort ? `:${this.#PORT}` : '',\n\t\t].join('');\n\t\tthis.#PATHNAME = url.pathname.replace(/\\/+$/, '');\n\t\tthis.#ABSOLUTE_URL = [\n\t\t\t`${this.#PROTOCOL}://`,\n\t\t\tthis.#HOST,\n\t\t\tthis.#PATHNAME,\n\t\t].join('');\n\t\tthis.rewriteRules = rewriteRules;\n\t\tthis.getFileNotFoundAction = getFileNotFoundAction;\n\t}\n\n\tasync getPrimaryPhp() {\n\t\treturn await this.processManager.getPrimaryPhp();\n\t}\n\n\t/**\n\t * Converts a path to an absolute URL based at the PHPRequestHandler\n\t * root.\n\t *\n\t * @param  path The server path to convert to an absolute URL.\n\t * @returns The absolute URL.\n\t */\n\tpathToInternalUrl(path: string): string {\n\t\treturn `${this.absoluteUrl}${path}`;\n\t}\n\n\t/**\n\t * Converts an absolute URL based at the PHPRequestHandler to a relative path\n\t * without the server pathname and scope.\n\t *\n\t * @param  internalUrl An absolute URL based at the PHPRequestHandler root.\n\t * @returns The relative path.\n\t */\n\tinternalUrlToPath(internalUrl: string): string {\n\t\tconst url = new URL(internalUrl);\n\t\tif (url.pathname.startsWith(this.#PATHNAME)) {\n\t\t\turl.pathname = url.pathname.slice(this.#PATHNAME.length);\n\t\t}\n\t\treturn toRelativeUrl(url);\n\t}\n\n\t/**\n\t * The absolute URL of this PHPRequestHandler instance.\n\t */\n\tget absoluteUrl() {\n\t\treturn this.#ABSOLUTE_URL;\n\t}\n\n\t/**\n\t * The directory in the PHP filesystem where the server will look\n\t * for the files to serve. Default: `/var/www`.\n\t */\n\tget documentRoot() {\n\t\treturn this.#DOCROOT;\n\t}\n\n\t/**\n\t * Serves the request – either by serving a static file, or by\n\t * dispatching it to the PHP runtime.\n\t *\n\t * The request() method mode behaves like a web server and only works if\n\t * the PHP was initialized with a `requestHandler` option (which the online\n\t * version of WordPress Playground does by default).\n\t *\n\t * In the request mode, you pass an object containing the request information\n\t * (method, headers, body, etc.) and the path to the PHP file to run:\n\t *\n\t * ```ts\n\t * const php = PHP.load('7.4', {\n\t * \trequestHandler: {\n\t * \t\tdocumentRoot: \"/www\"\n\t * \t}\n\t * })\n\t * php.writeFile(\"/www/index.php\", `<?php echo file_get_contents(\"php://input\");`);\n\t * const result = await php.request({\n\t * \tmethod: \"GET\",\n\t * \theaders: {\n\t * \t\t\"Content-Type\": \"text/plain\"\n\t * \t},\n\t * \tbody: \"Hello world!\",\n\t * \tpath: \"/www/index.php\"\n\t * });\n\t * // result.text === \"Hello world!\"\n\t * ```\n\t *\n\t * The `request()` method cannot be used in conjunction with `cli()`.\n\t *\n\t * @example\n\t * ```js\n\t * const output = await php.request({\n\t * \tmethod: 'GET',\n\t * \turl: '/index.php',\n\t * \theaders: {\n\t * \t\t'X-foo': 'bar',\n\t * \t},\n\t * \tbody: {\n\t * \t\tfoo: 'bar',\n\t * \t},\n\t * });\n\t * console.log(output.stdout); // \"Hello world!\"\n\t * ```\n\t *\n\t * @param  request - PHP Request data.\n\t */\n\tasync request(request: PHPRequest): Promise<PHPResponse> {\n\t\tconst isAbsolute = URL.canParse(request.url);\n\t\tconst requestedUrl = new URL(\n\t\t\t// Remove the hash part of the URL as it's not meant for the server.\n\t\t\trequest.url.split('#')[0],\n\t\t\tisAbsolute ? undefined : DEFAULT_BASE_URL\n\t\t);\n\n\t\tconst normalizedRequestedPath = applyRewriteRules(\n\t\t\tremovePathPrefix(\n\t\t\t\tdecodeURIComponent(requestedUrl.pathname),\n\t\t\t\tthis.#PATHNAME\n\t\t\t),\n\t\t\tthis.rewriteRules\n\t\t);\n\n\t\tconst primaryPhp = await this.getPrimaryPhp();\n\n\t\tlet fsPath = joinPaths(this.#DOCROOT, normalizedRequestedPath);\n\n\t\tif (primaryPhp.isDir(fsPath)) {\n\t\t\t// Ensure directory URIs have a trailing slash. Otherwise,\n\t\t\t// relative URIs in index.php or index.html files are relative\n\t\t\t// to the next directory up.\n\t\t\t//\n\t\t\t// Example:\n\t\t\t// For an index page served for URI \"/settings\", we naturally expect\n\t\t\t// links to be relative to \"/settings\", but without the trailing\n\t\t\t// slash, a relative link \"edit.php\" resolves to \"/edit.php\"\n\t\t\t// rather than \"/settings/edit.php\".\n\t\t\t//\n\t\t\t// This treatment of relative links is correct behavior for the browser:\n\t\t\t// https://www.rfc-editor.org/rfc/rfc3986#section-5.2.3\n\t\t\t//\n\t\t\t// But user intent for `/settings/index.php` is that its relative\n\t\t\t// URIs are relative to `/settings/`. So we redirect to add a\n\t\t\t// trailing slash to directory URIs to meet this expecatation.\n\t\t\t//\n\t\t\t// This behavior is also necessary for WordPress to function properly.\n\t\t\t// Otherwise, when viewing the WP admin dashboard at `/wp-admin`,\n\t\t\t// links to other admin pages like `edit.php` will incorrectly\n\t\t\t// resolve to `/edit.php` rather than `/wp-admin/edit.php`.\n\t\t\tif (!fsPath.endsWith('/')) {\n\t\t\t\treturn new PHPResponse(\n\t\t\t\t\t301,\n\t\t\t\t\t{ Location: [`${requestedUrl.pathname}/`] },\n\t\t\t\t\tnew Uint8Array(0)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// We can only satisfy requests for directories with a default file\n\t\t\t// so let's first resolve to a default path when available.\n\t\t\tfor (const possibleIndexFile of ['index.php', 'index.html']) {\n\t\t\t\tconst possibleIndexPath = joinPaths(fsPath, possibleIndexFile);\n\t\t\t\tif (primaryPhp.isFile(possibleIndexPath)) {\n\t\t\t\t\tfsPath = possibleIndexPath;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!primaryPhp.isFile(fsPath)) {\n\t\t\tconst fileNotFoundAction = this.getFileNotFoundAction(\n\t\t\t\tnormalizedRequestedPath\n\t\t\t);\n\t\t\tswitch (fileNotFoundAction.type) {\n\t\t\t\tcase 'response':\n\t\t\t\t\treturn fileNotFoundAction.response;\n\t\t\t\tcase 'internal-redirect':\n\t\t\t\t\tfsPath = joinPaths(this.#DOCROOT, fileNotFoundAction.uri);\n\t\t\t\t\tbreak;\n\t\t\t\tcase '404':\n\t\t\t\t\treturn PHPResponse.forHttpCode(404);\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t'Unsupported file-not-found action type: ' +\n\t\t\t\t\t\t\t// Cast because TS asserts the remaining possibility is `never`\n\t\t\t\t\t\t\t`'${\n\t\t\t\t\t\t\t\t(fileNotFoundAction as FileNotFoundAction).type\n\t\t\t\t\t\t\t}'`\n\t\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// We need to confirm that the current target file exists because\n\t\t// file-not-found fallback actions may redirect to non-existent files.\n\t\tif (primaryPhp.isFile(fsPath)) {\n\t\t\tif (fsPath.endsWith('.php')) {\n\t\t\t\tconst effectiveRequest: PHPRequest = {\n\t\t\t\t\t...request,\n\t\t\t\t\t// Pass along URL with the #fragment filtered out\n\t\t\t\t\turl: requestedUrl.toString(),\n\t\t\t\t};\n\t\t\t\treturn this.#spawnPHPAndDispatchRequest(\n\t\t\t\t\teffectiveRequest,\n\t\t\t\t\tfsPath\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\treturn this.#serveStaticFile(primaryPhp, fsPath);\n\t\t\t}\n\t\t} else {\n\t\t\treturn PHPResponse.forHttpCode(404);\n\t\t}\n\t}\n\n\t/**\n\t * Serves a static file from the PHP filesystem.\n\t *\n\t * @param  fsPath - Absolute path of the static file to serve.\n\t * @returns The response.\n\t */\n\t#serveStaticFile(php: PHP, fsPath: string): PHPResponse {\n\t\tconst arrayBuffer = php.readFileAsBuffer(fsPath);\n\t\treturn new PHPResponse(\n\t\t\t200,\n\t\t\t{\n\t\t\t\t'content-length': [`${arrayBuffer.byteLength}`],\n\t\t\t\t// @TODO: Infer the content-type from the arrayBuffer instead of the\n\t\t\t\t// file path. The code below won't return the correct mime-type if the\n\t\t\t\t// extension was tampered with.\n\t\t\t\t'content-type': [inferMimeType(fsPath)],\n\t\t\t\t'accept-ranges': ['bytes'],\n\t\t\t\t'cache-control': ['public, max-age=0'],\n\t\t\t},\n\t\t\tarrayBuffer\n\t\t);\n\t}\n\n\t/**\n\t * Spawns a new PHP instance and dispatches a request to it.\n\t */\n\tasync #spawnPHPAndDispatchRequest(\n\t\trequest: PHPRequest,\n\t\tscriptPath: string\n\t): Promise<PHPResponse> {\n\t\tlet spawnedPHP: SpawnedPHP | undefined = undefined;\n\t\ttry {\n\t\t\tspawnedPHP = await this.processManager!.acquirePHPInstance({\n\t\t\t\tconsiderPrimary: true,\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tif (e instanceof MaxPhpInstancesError) {\n\t\t\t\treturn PHPResponse.forHttpCode(502);\n\t\t\t} else {\n\t\t\t\treturn PHPResponse.forHttpCode(500);\n\t\t\t}\n\t\t}\n\t\ttry {\n\t\t\treturn await this.#dispatchToPHP(\n\t\t\t\tspawnedPHP.php,\n\t\t\t\trequest,\n\t\t\t\tscriptPath\n\t\t\t);\n\t\t} finally {\n\t\t\tspawnedPHP.reap();\n\t\t}\n\t}\n\n\t/**\n\t * Runs the requested PHP file with all the request and $_SERVER\n\t * superglobals populated.\n\t *\n\t * @param  request - The request.\n\t * @returns The response.\n\t */\n\tasync #dispatchToPHP(\n\t\tphp: PHP,\n\t\trequest: PHPRequest,\n\t\tscriptPath: string\n\t): Promise<PHPResponse> {\n\t\tlet preferredMethod: PHPRunOptions['method'] = 'GET';\n\n\t\tconst headers: Record<string, string> = {\n\t\t\thost: this.#HOST,\n\t\t\t...normalizeHeaders(request.headers || {}),\n\t\t};\n\t\tif (this.#cookieStore) {\n\t\t\theaders['cookie'] = this.#cookieStore.getCookieRequestHeader();\n\t\t}\n\n\t\tlet body = request.body;\n\t\tif (typeof body === 'object' && !(body instanceof Uint8Array)) {\n\t\t\tpreferredMethod = 'POST';\n\t\t\tconst { bytes, contentType } = await encodeAsMultipart(body);\n\t\t\tbody = bytes;\n\t\t\theaders['content-type'] = contentType;\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await php.run({\n\t\t\t\trelativeUri: ensurePathPrefix(\n\t\t\t\t\ttoRelativeUrl(new URL(request.url)),\n\t\t\t\t\tthis.#PATHNAME\n\t\t\t\t),\n\t\t\t\tprotocol: this.#PROTOCOL,\n\t\t\t\tmethod: request.method || preferredMethod,\n\t\t\t\t$_SERVER: {\n\t\t\t\t\tREMOTE_ADDR: '127.0.0.1',\n\t\t\t\t\tDOCUMENT_ROOT: this.#DOCROOT,\n\t\t\t\t\tHTTPS: this.#ABSOLUTE_URL.startsWith('https://')\n\t\t\t\t\t\t? 'on'\n\t\t\t\t\t\t: '',\n\t\t\t\t},\n\t\t\t\tbody,\n\t\t\t\tscriptPath,\n\t\t\t\theaders,\n\t\t\t});\n\t\t\tif (this.#cookieStore) {\n\t\t\t\tthis.#cookieStore.rememberCookiesFromResponseHeaders(\n\t\t\t\t\tresponse.headers\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn response;\n\t\t} catch (error) {\n\t\t\tconst executionError = error as PHPExecutionFailureError;\n\t\t\tif (executionError?.response) {\n\t\t\t\treturn executionError.response;\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tasync [Symbol.asyncDispose]() {\n\t\tawait this.processManager[Symbol.asyncDispose]();\n\t}\n}\n\n/**\n * Naively infer a file mime type from its path.\n *\n * @todo Infer the mime type based on the file contents.\n *       A naive function like this one can be inaccurate\n *       and potentially have negative security consequences.\n *\n * @param  path - The file path\n * @returns The inferred mime type.\n */\nfunction inferMimeType(path: string): string {\n\tconst extension = path.split('.').pop() as keyof typeof mimeTypes;\n\t// @TODO: Consider not sending a default mime type to let the browser guess\n\treturn mimeTypes[extension] || mimeTypes['_default'];\n}\n\n/**\n * Applies the given rewrite rules to the given path.\n *\n * @param  path  The path to apply the rules to.\n * @param  rules The rules to apply.\n * @returns The path with the rules applied.\n */\nexport function applyRewriteRules(path: string, rules: RewriteRule[]): string {\n\tfor (const rule of rules) {\n\t\tif (new RegExp(rule.match).test(path)) {\n\t\t\treturn path.replace(rule.match, rule.replacement);\n\t\t}\n\t}\n\treturn path;\n}\n","import type { PHP } from './php';\nimport type { PHPEvent } from './universal-php';\n\nexport interface RotateOptions {\n\tphp: PHP;\n\tcwd: string;\n\trecreateRuntime: () => Promise<number> | number;\n\tmaxRequests: number;\n}\n\n/**\n * Listens to PHP events and swaps the internal PHP Runtime for a fresh one\n * after a certain number of run() calls (which are responsible for handling\n * HTTP requests).\n *\n * Why? Because PHP and PHP extension have a memory leak. Each request leaves\n * the memory a bit more fragmented and with a bit less available space than\n * before. Eventually, new allocations start failing.\n *\n * Rotating the PHP instance may seem like a workaround, but it's actually\n * what PHP-FPM does natively:\n *\n * https://www.php.net/manual/en/install.fpm.configuration.php#pm.max-tasks\n *\n * @return cleanup function to restore\n */\nexport function rotatePHPRuntime({\n\tphp,\n\tcwd,\n\trecreateRuntime,\n\t/*\n\t * 400 is an arbitrary number that should trigger a rotation\n\t * way before the memory gets too fragmented. If it doesn't,\n\t * let's explore:\n\t * * Rotating based on an actual memory usage and\n\t *   fragmentation.\n\t * * Resetting HEAP to its initial value.\n\t */\n\tmaxRequests = 400,\n}: RotateOptions) {\n\tlet runtimeRequestCount = 0;\n\tasync function rotateRuntime() {\n\t\tconst release = await php.semaphore.acquire();\n\t\ttry {\n\t\t\tawait php.hotSwapPHPRuntime(await recreateRuntime(), cwd);\n\n\t\t\t// A new runtime has handled zero requests.\n\t\t\truntimeRequestCount = 0;\n\t\t} finally {\n\t\t\trelease();\n\t\t}\n\t}\n\n\tasync function rotateRuntimeAfterMaxRequests() {\n\t\tif (++runtimeRequestCount < maxRequests) {\n\t\t\treturn;\n\t\t}\n\t\tawait rotateRuntime();\n\t}\n\n\tasync function rotateRuntimeForPhpWasmError(event: PHPEvent) {\n\t\tif (event.type === 'request.error' && event.source === 'php-wasm') {\n\t\t\tawait rotateRuntime();\n\t\t}\n\t}\n\n\tphp.addEventListener('request.error', rotateRuntimeForPhpWasmError);\n\tphp.addEventListener('request.end', rotateRuntimeAfterMaxRequests);\n\n\treturn function () {\n\t\tphp.removeEventListener('request.error', rotateRuntimeForPhpWasmError);\n\t\tphp.removeEventListener('request.end', rotateRuntimeAfterMaxRequests);\n\t};\n}\n","import { dirname, joinPaths } from '@php-wasm/util';\nimport type { UniversalPHP } from './universal-php';\n\n// eslint-disable-next-line @typescript-eslint/no-empty-object-type\nexport interface FileTree\n\textends Record<string, Uint8Array | string | FileTree> {}\n\nexport interface WriteFilesOptions {\n\t/**\n\t * Whether to wipe out the contents of the\n\t * root directory before writing the new files.\n\t */\n\trmRoot?: boolean;\n}\n\n/**\n * Writes multiple files to a specified directory in the Playground\n * filesystem.\n *\n * @example ```ts\n * await writeFiles(php, '/test', {\n * \t'file.txt': 'file',\n * \t'sub/file.txt': 'file',\n * \t'sub1/sub2/file.txt': 'file',\n * });\n * ```\n *\n * @param php\n * @param root\n * @param newFiles\n * @param options\n */\nexport async function writeFiles(\n\tphp: UniversalPHP,\n\troot: string,\n\tnewFiles: FileTree,\n\t{ rmRoot = false }: WriteFilesOptions = {}\n) {\n\tif (rmRoot) {\n\t\tif (await php.isDir(root)) {\n\t\t\tawait php.rmdir(root, { recursive: true });\n\t\t}\n\t}\n\tfor (const [relativePath, content] of Object.entries(newFiles)) {\n\t\tconst filePath = joinPaths(root, relativePath);\n\t\tif (!(await php.fileExists(dirname(filePath)))) {\n\t\t\tawait php.mkdir(dirname(filePath));\n\t\t}\n\t\tif (content instanceof Uint8Array || typeof content === 'string') {\n\t\t\tawait php.writeFile(filePath, content);\n\t\t} else {\n\t\t\tawait writeFiles(php, filePath, content);\n\t\t}\n\t}\n}\n","import type { PHP } from './php';\n\n/**\n * Proxy specific paths to the parent's MEMFS instance.\n * This is useful for sharing the WordPress installation\n * between the parent and child processes.\n */\nexport function proxyFileSystem(\n\tsourceOfTruth: PHP,\n\treplica: PHP,\n\tpaths: string[]\n) {\n\t// We can't just import the symbol from the library because\n\t// Playground CLI is built as ESM and php-wasm-node is built as\n\t// CJS and the imported symbols will different in the production build.\n\tconst __private__symbol = Object.getOwnPropertySymbols(sourceOfTruth)[0];\n\tfor (const path of paths) {\n\t\tif (!replica.fileExists(path)) {\n\t\t\treplica.mkdir(path);\n\t\t}\n\t\tif (!sourceOfTruth.fileExists(path)) {\n\t\t\tsourceOfTruth.mkdir(path);\n\t\t}\n\t\t// @ts-ignore\n\t\treplica[__private__symbol].FS.mount(\n\t\t\t// @ts-ignore\n\t\t\treplica[__private__symbol].PROXYFS,\n\t\t\t{\n\t\t\t\troot: path,\n\t\t\t\t// @ts-ignore\n\t\t\t\tfs: sourceOfTruth[__private__symbol].FS,\n\t\t\t},\n\t\t\tpath\n\t\t);\n\t}\n}\n","/**\n * @license\n * Copyright 2019 Google LLC\n * SPDX-License-Identifier: Apache-2.0\n */\nfunction nodeEndpoint(nep) {\n    const listeners = new WeakMap();\n    return {\n        postMessage: nep.postMessage.bind(nep),\n        addEventListener: (_, eh) => {\n            const l = (data) => {\n                if (\"handleEvent\" in eh) {\n                    eh.handleEvent({ data });\n                }\n                else {\n                    eh({ data });\n                }\n            };\n            nep.on(\"message\", l);\n            listeners.set(eh, l);\n        },\n        removeEventListener: (_, eh) => {\n            const l = listeners.get(eh);\n            if (!l) {\n                return;\n            }\n            nep.off(\"message\", l);\n            listeners.delete(eh);\n        },\n        start: nep.start && nep.start.bind(nep),\n    };\n}\n\nexport { nodeEndpoint as default };\n//# sourceMappingURL=node-adapter.mjs.map\n","import type { PHPResponseData } from './php-response';\nimport { PHPResponse } from './php-response';\nimport type { Endpoint } from 'comlink';\nimport * as Comlink from 'comlink';\nimport type { NodeEndpoint } from 'comlink/dist/esm/node-adapter';\nimport nodeEndpoint from 'comlink/dist/esm/node-adapter';\n\nexport type WithAPIState = {\n\t/**\n\t * Resolves to true when the remote API is ready for\n\t * Comlink communication, but not necessarily fully initialized yet.\n\t */\n\tisConnected: () => Promise<void>;\n\t/**\n\t * Resolves to true when the remote API is declares it's\n\t * fully loaded and ready to be used.\n\t */\n\tisReady: () => Promise<void>;\n};\nexport type RemoteAPI<T> = Comlink.Remote<T> & WithAPIState;\n\nexport function consumeAPI<APIType>(\n\tremote: Worker | Window | NodeEndpoint,\n\tcontext: undefined | EventTarget = undefined\n): RemoteAPI<APIType> {\n\tsetupTransferHandlers();\n\n\tlet endpoint;\n\tconst appearsToBeNodeEnvironment = import.meta.url.startsWith('file://');\n\tif (appearsToBeNodeEnvironment) {\n\t\tendpoint = nodeEndpoint(remote as NodeEndpoint);\n\t} else {\n\t\tendpoint =\n\t\t\tremote instanceof Worker\n\t\t\t\t? remote\n\t\t\t\t: Comlink.windowEndpoint(remote as Window, context);\n\t}\n\n\t/**\n\t * This shouldn't be necessary, but Comlink doesn't seem to\n\t * handle the initial isConnected() call correctly unless it's\n\t * explicitly provided here. This is especially weird\n\t * since the only thing this proxy does is to call the\n\t * isConnected() method on the remote API.\n\t *\n\t * @TODO: Remove this workaround.\n\t */\n\tconst api = Comlink.wrap<APIType & WithAPIState>(endpoint);\n\tconst methods = proxyClone(api);\n\treturn new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn async () => {\n\t\t\t\t\t// Keep retrying until the remote API confirms it's connected.\n\t\t\t\t\twhile (true) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait runWithTimeout(api.isConnected(), 200);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Timeout exceeded, try again. We can't just use a single\n\t\t\t\t\t\t\t// `runWithTimeout` call because it won't reach the remote API\n\t\t\t\t\t\t\t// if it's not connected yet. Instead, we need to keep retrying\n\t\t\t\t\t\t\t// until the remote API is connected and registers a handler\n\t\t\t\t\t\t\t// for the `isConnected` method.\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn (api as any)[prop];\n\t\t},\n\t}) as unknown as RemoteAPI<APIType>;\n}\n\nasync function runWithTimeout<T>(\n\tpromise: Promise<T>,\n\ttimeout: number\n): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\tsetTimeout(reject, timeout);\n\t\tpromise.then(resolve);\n\t});\n}\n\nexport type PublicAPI<Methods, PipedAPI = unknown> = RemoteAPI<\n\tMethods & PipedAPI\n>;\nexport function exposeAPI<Methods, PipedAPI>(\n\tapiMethods?: Methods,\n\tpipedApi?: PipedAPI,\n\ttargetWorker?: NodeEndpoint\n): [() => void, (e: Error) => void, PublicAPI<Methods, PipedAPI>] {\n\tsetupTransferHandlers();\n\n\tconst connected = Promise.resolve();\n\n\tlet setReady: any;\n\tlet setFailed: any;\n\tconst ready = new Promise((resolve, reject) => {\n\t\tsetReady = resolve;\n\t\tsetFailed = reject;\n\t});\n\n\tconst methods = proxyClone(apiMethods);\n\tconst exposedApi = new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn () => connected;\n\t\t\t} else if (prop === 'isReady') {\n\t\t\t\treturn () => ready;\n\t\t\t} else if (prop in target) {\n\t\t\t\treturn target[prop];\n\t\t\t}\n\t\t\treturn (pipedApi as any)?.[prop];\n\t\t},\n\t}) as unknown as PublicAPI<Methods, PipedAPI>;\n\n\tlet endpoint: Endpoint | undefined;\n\tif (targetWorker) {\n\t\t// NOTE: If there are other target types, we could expand this later,\n\t\t// but for now, we only need support for NodeEndpoints.\n\t\tendpoint = nodeEndpoint(targetWorker);\n\t} else {\n\t\tendpoint =\n\t\t\ttypeof window !== 'undefined'\n\t\t\t\t? Comlink.windowEndpoint(self.parent)\n\t\t\t\t: undefined;\n\t}\n\n\tComlink.expose(exposedApi, endpoint);\n\n\treturn [setReady, setFailed, exposedApi];\n}\n\nlet isTransferHandlersSetup = false;\nfunction setupTransferHandlers() {\n\tif (isTransferHandlersSetup) {\n\t\treturn;\n\t}\n\tisTransferHandlersSetup = true;\n\tComlink.transferHandlers.set('EVENT', {\n\t\tcanHandle: (obj): obj is CustomEvent => obj instanceof CustomEvent,\n\t\tserialize: (ev: CustomEvent) => {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tdetail: ev.detail,\n\t\t\t\t},\n\t\t\t\t[],\n\t\t\t];\n\t\t},\n\t\tdeserialize: (obj) => obj,\n\t});\n\tComlink.transferHandlers.set('FUNCTION', {\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\t\tcanHandle: (obj: unknown): obj is Function => typeof obj === 'function',\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\t\tserialize(obj: Function) {\n\t\t\tconst { port1, port2 } = new MessageChannel();\n\t\t\tComlink.expose(obj, port1);\n\t\t\treturn [port2, [port2]];\n\t\t},\n\t\tdeserialize(port: any) {\n\t\t\tport.start();\n\t\t\treturn Comlink.wrap(port);\n\t\t},\n\t});\n\tComlink.transferHandlers.set('PHPResponse', {\n\t\tcanHandle: (obj: unknown): obj is PHPResponseData =>\n\t\t\ttypeof obj === 'object' &&\n\t\t\tobj !== null &&\n\t\t\t'headers' in obj &&\n\t\t\t'bytes' in obj &&\n\t\t\t'errors' in obj &&\n\t\t\t'exitCode' in obj &&\n\t\t\t'httpStatusCode' in obj,\n\t\tserialize(obj: PHPResponse): [PHPResponseData, Transferable[]] {\n\t\t\treturn [obj.toRawData(), []];\n\t\t},\n\t\tdeserialize(responseData: PHPResponseData): PHPResponse {\n\t\t\treturn PHPResponse.fromRawData(responseData);\n\t\t},\n\t});\n\t// Augment Comlink's throw handler to include Error the response and source\n\t// information in the serialized error object. BasePHP may throw\n\t// PHPExecutionFailureError which includes those information and we'll want to\n\t// display them for the user.\n\tconst throwHandler = Comlink.transferHandlers.get('throw')!;\n\tconst originalSerialize = throwHandler?.serialize;\n\tthrowHandler.serialize = ({ value }: any) => {\n\t\tconst serialized = originalSerialize({ value }) as any;\n\t\tif (value.response) {\n\t\t\tserialized[0].value.response = value.response;\n\t\t}\n\t\tif (value.source) {\n\t\t\tserialized[0].value.source = value.source;\n\t\t}\n\t\treturn serialized;\n\t};\n}\n\nfunction proxyClone(object: any): any {\n\treturn new Proxy(object, {\n\t\tget(target, prop) {\n\t\t\tswitch (typeof target[prop]) {\n\t\t\t\tcase 'function':\n\t\t\t\t\treturn (...args: any[]) => target[prop](...args);\n\t\t\t\tcase 'object':\n\t\t\t\t\tif (target[prop] === null) {\n\t\t\t\t\t\treturn target[prop];\n\t\t\t\t\t}\n\t\t\t\t\treturn proxyClone(target[prop]);\n\t\t\t\tcase 'undefined':\n\t\t\t\tcase 'number':\n\t\t\t\tcase 'string':\n\t\t\t\t\treturn target[prop];\n\t\t\t\tdefault:\n\t\t\t\t\treturn Comlink.proxy(target[prop]);\n\t\t\t}\n\t\t},\n\t});\n}\n"],"names":["e","errno","messagePrefix","value","args","errmsg","path","formattedPrefix","FS","data","fromPath","toPath","fromMount","toMount","dirname","options","file","filePath","joinPaths","files","name","prepend","logger","target","link","fromNode","filenames","filename","requestHandler","monitor","php","internalUrl","callback","_a","request","reap","newName","listener","key","eventType","headers","stdout","stderr","exitCode","statusCode","result","headersStream","headersText","headersData","line","colonIndex","headerName","headerValue","stream","reader","text","done","httpStatusCode","body","errors","streamedResponse","phpLoaderModule","phpModuleArgs","phpReady","resolvePHP","rejectPHP","PHPRuntime","reason","id","code","methods","promise","resolve","reject","type","runtime","original","clearMessage","event","crypticError","asyncifyStack","betterMessage","uniqueFunctions","lastError","fn","message","stack","names","parts","isWasm","response","source","PHPRuntimeId","__privateAdd","_PHP_instances","_sapiName","_webSapiInitialized","_wasmErrorsTarget","_eventListeners","_messageListeners","_mounts","Semaphore","__privateGet","listeners","__privateSet","l","createSpawnHandler","runtimeId","returnData","syncResponse","error","release","heapBodyPointer","streamedResponsePromise","__privateMethod","executeWithErrorHandling_fn","initWebRuntime_fn","setRelativeRequestUri_fn","setRequestMethod_fn","requestHeaders","host","port","inferPortFromHostAndProtocol_fn","setRequestHost_fn","setRequestPort_fn","setRequestHeaders_fn","setRequestBody_fn","setScriptPath_fn","$_SERVER","prepareServerEntries_fn","setServerGlobalEntry_fn","env","setEnv_fn","consts","cwd","oldFS","mountHandlers","vfsPath","mount","mountHandler","virtualFSPath","unmountCallback","mountObject","argv","arg","shouldSkip","defaults","HTTP_prefix","uri","queryString","protocol","method","size","contentLength","executionFn","emscriptenModule","chunk","streamsClosed","headersClosed","closeHeadersStream","errorListener","exitCodePromise","_","rethrown","err","normalized","oldNode","controllerResolve","controllerPromise","controller","entries","ini","parse","stringify","phpIniValues","iniBefore","setCookie","equalsIndex","cookiesArray","buffer","root","relativePaths","pathPrefix","exceptPaths","normalizePath","currentParent","absPath","StreamedFile","limit","considerPrimary","spawnedPhp","factoryArgs","spawned","pop","instance","rejection","AcquireTimeoutError","url","prefix","boundary","contentType","textEncoder","length","acc","part","bytes","offset","fileBuffer","config","_PHPRequestHandler_instances","_DOCROOT","_PROTOCOL","_HOSTNAME","_PORT","_HOST","_PATHNAME","_ABSOLUTE_URL","_cookieStore","documentRoot","absoluteUrl","rewriteRules","getFileNotFoundAction","info","isNonStandardPort","isAbsolute","requestedUrl","normalizedRequestedPath","primaryPhp","fsPath","possibleIndexFile","possibleIndexPath","fileNotFoundAction","effectiveRequest","spawnPHPAndDispatchRequest_fn","serveStaticFile_fn","arrayBuffer","scriptPath","spawnedPHP","dispatchToPHP_fn","preferredMethod","executionError","extension","rules","rule","recreateRuntime","maxRequests","runtimeRequestCount","rotateRuntime","rotateRuntimeAfterMaxRequests","rotateRuntimeForPhpWasmError","newFiles","rmRoot","relativePath","content","sourceOfTruth","replica","paths","__private__symbol","nep","eh","remote","context","endpoint","Comlink","api","prop","timeout","apiMethods","pipedApi","targetWorker","connected","setReady","setFailed","ready","exposedApi","obj","ev","port1","port2","responseData","throwHandler","originalSerialize","serialized","object"],"mappings":"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","x_google_ignoreList":[22]}