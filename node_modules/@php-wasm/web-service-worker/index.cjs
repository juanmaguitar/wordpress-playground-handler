"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const d=require("@php-wasm/scopes"),f=25e3;let y=0;function R(e,t,...o){const n=u();return e.postMessage({...t,requestId:n},...o),n}function u(){return++y}function l(e,t,o=f){return new Promise((n,c)=>{const r=a=>{a.data.type==="response"&&a.data.requestId===t&&(e.removeEventListener("message",r),clearTimeout(s),n(a.data.response))},s=setTimeout(()=>{c(new Error("Request timed out")),e.removeEventListener("message",r)},o);e.addEventListener("message",r)})}function g(e,t){return{type:"response",requestId:e,response:t}}async function m(e){let t=new URL(e.request.url);if(!d.isURLScoped(t))try{const s=new URL(e.request.referrer);t=d.setURLScope(t,d.getURLScope(s))}catch{}const o=e.request.headers.get("content-type"),n=e.request.method==="POST"?new Uint8Array(await e.request.clone().arrayBuffer()):void 0,c={};for(const s of e.request.headers.entries())c[s[0]]=s[1];let r;try{const s={method:"request",args:[{body:n,url:t.toString(),method:e.request.method,headers:{...c,Host:t.host,"User-agent":self.navigator.userAgent,"Content-type":o}}]},a=d.getURLScope(t);if(a===null)throw new Error(`The URL ${t.toString()} is not scoped. This should not happen.`);const h=await p(s,a);r=await l(self,h),delete r.headers["x-frame-options"]}catch(s){throw console.error(s,{url:t.toString()}),s}return r.httpStatusCode>=300&&r.httpStatusCode<=399&&r.headers.location?Response.redirect(r.headers.location[0],r.httpStatusCode):new Response(r.bytes,{headers:r.headers,status:r.httpStatusCode})}async function p(e,t){const o=u();for(const n of await self.clients.matchAll({includeUncontrolled:!0}))n.postMessage({...e,scope:t,requestId:o});return o}async function i(e,t){const o=["GET","HEAD"].includes(e.method)||"body"in t?void 0:await e.blob();return new Request(t.url||e.url,{body:o,method:e.method,headers:e.headers,referrer:e.referrer,referrerPolicy:e.referrerPolicy,mode:e.mode==="navigate"?"same-origin":e.mode,credentials:e.credentials,cache:e.cache,redirect:e.redirect,integrity:e.integrity,...t})}async function w(e){if(!e.body)return[e,e];const[t,o]=e.body.tee();return[await i(e,{body:t,duplex:"half"}),await i(e,{body:o,duplex:"half"})]}function E(e){const t={};return e.headers.forEach((o,n)=>{t[n]=o}),t}exports.awaitReply=l;exports.broadcastMessageExpectReply=p;exports.cloneRequest=i;exports.convertFetchEventToPHPRequest=m;exports.getNextRequestId=u;exports.getRequestHeaders=E;exports.postMessageExpectReply=R;exports.responseTo=g;exports.teeRequest=w;
